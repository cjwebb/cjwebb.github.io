<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: scala | cjwebb.github.io]]></title>
  <link href="http://cjwebb.github.io/blog/categories/scala/atom.xml" rel="self"/>
  <link href="http://cjwebb.github.io/"/>
  <updated>2017-01-02T11:21:06+00:00</updated>
  <id>http://cjwebb.github.io/</id>
  <author>
    <name><![CDATA[Colin Webb]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[DynamoDB with Scala Macros]]></title>
    <link href="http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros/"/>
    <updated>2017-01-02T11:00:00+00:00</updated>
    <id>http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros</id>
    <content type="html"><![CDATA[<p>I&rsquo;ve spent the last year using <a href="https://aws.amazon.com/documentation/dynamodb/">AWS DynamoDB</a> at work. When we initially searched for a Scala client for DynamoDB, we had the following criteria:</p>

<ul>
<li>Good for Scala beginners</li>
<li>Up to date</li>
<li>Well documented</li>
</ul>


<p>Sadly, none of the Scala libraries available at that time matched all three criteria. The most up-to-date libraries were not suitable for a team starting out with Scala and DynamoDB. The most beginner-friendly libraries were out-of-date, and most only had superficial documentation.</p>

<p>The closest to matching all three criteria was the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.Java.html">official AWS SDK</a>, but it was written in Java. We used eventually used a thin layer of Scala Macros to make it nicer to use for Scala beginners, and experts alike.</p>

<h2>Plain Old Java DynamoDB API</h2>

<p>The Java DynamoDB SDK is not pleasant to use. There is a lot of boilerplate.</p>

<p>In order to do simple inserts, you must construct a <code>java.util.Map[String, AttributeValue]</code>. For a simple case class, this conversion is simple:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">SimpleCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="n">format</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">SimpleCaseClass</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Map</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">asJava</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>For nested case classes, this gets ugly.
In order to place a nested structure into DynamoDB, you must construct another map of <code>AttributeValue</code> inside of a <code>AttributeValue().withM</code>, where <code>withM</code> means <code>withMap</code>. DynamoDB has a few abbreviations like <code>M</code>, <code>N</code>, <code>S</code>, which are the type of data you&rsquo;re sending to Dynamo. <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html">You can read the full list on the official docs</a>.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">SimpleCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">NestedCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">simple</span><span class="k">:</span> <span class="kt">SimpleCaseClass</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">NestedCaseClass</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Map</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">simple</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">().</span><span class="n">withM</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">nestedId</span><span class="o">),</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">simple</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)</span>
</span><span class='line'>   <span class="o">).</span><span class="n">asJava</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">asJava</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I&rsquo;m sure you can imagine how tiresome writing this type of code became. We wrote a macro to generate this boilerplate for us.</p>

<h2>Don&rsquo;t Write Macros</h2>

<blockquote><p>The first rule of macro club is don&rsquo;t write macros</p></blockquote>

<p>Macros are confusing. Using a macro means you write your code, the macro rewrites it, and then we execute the code without really knowing what the code now looks like. Macros can make code more complicated, and should be avoided in most situations.</p>

<blockquote><p>The second rule of macro club is to write the simplest macro possible.</p></blockquote>

<p>I made this one up, but I like it. If you <em>have</em> to write a macro, write one so simple that anyone can understand how it works. Write one that is so simple that it can be explained in a blog post!</p>

<h2>An Intermediate Representation</h2>

<p>Following the second rule of macro club, we defined some simple functions and typeclasses that simplified the macro. This also had the advantage of yielding more control than a macro did.</p>

<p>For instance, we wanted better control over the AttributeValue key names, so we defined <code>DynamoWrites</code> and <code>DynamoReads</code>. As we use Play Framework a lot, they were heavily influenced by Play JSON Writes and Reads. <code>DynamoReadResult</code> was inspired by Play JSON&rsquo;s <code>JsResult</code>. The only difference is that this <code>DynamoReads</code> code fails fast rather than using an applicative to collect all the errors.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">writeFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoWrites</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DynamoValue</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">map</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">id</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">name</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">email</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="o">)</span>
</span><span class='line'><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">implicit</span> <span class="k">val</span> <span class="n">readFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoReads</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">DynamoValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">DynamoReadResult</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">id</span>    <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="o">&gt;</span><span class="nc">String</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="n">name</span>  <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;name&quot;</span><span class="o">&gt;</span><span class="nc">String</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="n">email</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;&quot;</span> <span class="n">title</span><span class="o">=</span><span class="s">&quot;email&quot;</span><span class="o">&gt;</span><span class="nc">String</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">email</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>With these defined, writing the macros was simpler, and we have a nicer representation than the Java SDK to fallback to if the macro doesn&rsquo;t quite meet our needs.</p>

<h2>Macros Explained!</h2>

<p>Below is a macro. It generates a <code>DynamoWrites</code> implementation for a case class:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">formatWriteImpl</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;c:%20whitebox.Context&quot;</span><span class="o">&gt;</span><span class="n">T</span><span class="k">:</span> <span class="kt">c.WeakTypeTag&lt;/a</span><span class="k">&gt;:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">c.universe._&lt;/p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">toMapParams</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toTermName</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>    <span class="n">q</span><span class="s">&quot;($decoded -&gt; o.$name)&amp;ldquo;</span>
</span><span class='line'><span class="s">  }&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">&lt;p&gt;  c.Expr[DynamoWrites[T]] { q&quot;</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;</span>
</span><span class='line'>    <span class="k">new</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">root</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;.</span><span class="n">com</span><span class="o">.</span><span class="n">netaporter</span><span class="o">.</span><span class="n">dynamomapper</span><span class="o">.</span><span class="nc">DynamoWrites</span><span class="o">[</span><span class="kt">$tpe</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">$tpe</span><span class="o">)</span> <span class="k">=</span> <span class="n">map</span><span class="o">(..</span><span class="nc">$toMapParams</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;&amp;</span><span class="n">ldquo</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>It doesn&rsquo;t look simple though! Let&rsquo;s break it down. Scala macros contain <strong>a lot</strong> of boilerplate. However, this is boilerplate that we only had to write once, rather than every time we wanted to convert a case class.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">formatWriteImpl</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;c:%20whitebox.Context&quot;</span><span class="o">&gt;</span><span class="n">T</span><span class="k">:</span> <span class="kt">c.WeakTypeTag&lt;/a</span><span class="k">&gt;:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>The first line (above) is the type signature. Crucially, it finishes with <code>c.Expr[DynamoWrites[T]]</code>. This means we return an <code>Expression</code> of <code>DynamoWrites[T]</code>.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'><span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Next, we have some typelevel programming. <code>tpe</code> enabled us to query the type of <code>T</code>. Types expose declarations (or <code>decls</code>), such as their constructors, methods, variables etc. This code finds the constructor, and gets the fields we need to provide in order to instantiate an instance of the case class. For the <code>DynamoWrites</code>, we need to know what the type is expecting in order to write it.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">toMapParams</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toTermName</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>  <span class="n">q</span><span class="err">&quot;</span><span class="o">(</span><span class="nc">$decoded</span> <span class="o">-&gt;</span> <span class="n">o</span><span class="o">.</span><span class="nc">$name</span><span class="o">)&amp;</span><span class="n">ldquo</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><code>toMapParams</code> maps over the fields and returns a map of names to values contained in an a type. <code>decoded</code> is the string name of the field, and <code>o.$name</code> invokes the that field on an object <code>o</code>. This object is provided by the implementation of the <code>DynamoWrites</code>:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="err">&quot;</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;</span>
</span><span class='line'>  <span class="k">new</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">root</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;.</span><span class="n">com</span><span class="o">.</span><span class="n">netaporter</span><span class="o">.</span><span class="n">dynamomapper</span><span class="o">.</span><span class="nc">DynamoWrites</span><span class="o">[</span><span class="kt">$tpe</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">$tpe</span><span class="o">)</span> <span class="k">=</span> <span class="n">map</span><span class="o">(..</span><span class="nc">$toMapParams</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;&amp;</span><span class="n">ldquo</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>This is where the magic happens. We use quasiquotes to create our <code>DynamoWrites[T]</code>, and specify that <code>o</code> is type <code>T</code>. Quasiquotes are essentially string interpolation, with <a href="http://docs.scala-lang.org/overviews/quasiquotes/expression-details.html">various notations</a>. We inserted our previously constructed field-map using the <code>..$</code> notation. The double-dots denote that we passed a list.</p>

<h2>Macros Again!</h2>

<p>We still needed a macro for <code>DynamoReads</code>. Luckily, it is almost the same as before. Copy paste, with a few alterations.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.language.higherKinds</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.reflect.macros._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.language.experimental.macros</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">def</span> <span class="n">formatReadImpl</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;c:%20whitebox.Context&quot;</span><span class="o">&gt;</span><span class="n">T</span><span class="k">:</span> <span class="kt">c.WeakTypeTag&lt;/a</span><span class="k">&gt;:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoReads</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">c.universe._&lt;/p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">companionObj</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">typeSymbol</span><span class="o">.</span><span class="n">companion</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="o">(</span><span class="n">names</span><span class="o">,</span> <span class="n">fromMapParams</span><span class="o">)</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">asTerm</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">returnType</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decl</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="n">typeSignature</span>
</span><span class='line'>    <span class="o">(</span><span class="n">q</span><span class="s">&quot;$name&quot;</span><span class="o">,</span> <span class="n">fq</span><span class="s">&quot;&amp;ldquo;&amp;rdquo;$name &amp;lt;- o.attr&lt;a href=&quot;</span><span class="nc">$decoded</span><span class="s">&quot;&gt;$returnType&lt;/a&gt;&amp;ldquo;&amp;rdquo;&amp;ldquo;)</span>
</span><span class='line'><span class="s">  }.unzip&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="s">&lt;p&gt;  c.Expr[DynamoReads[T]] { q&quot;</span><span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;</span>
</span><span class='line'>    <span class="k">new</span> <span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span><span class="n">root</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;.</span><span class="n">com</span><span class="o">.</span><span class="n">netaporter</span><span class="o">.</span><span class="n">dynamomapper</span><span class="o">.</span><span class="nc">DynamoReads</span><span class="o">[</span><span class="kt">$tpe</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">&lt;em&gt;root&lt;/em&gt;.com.netaporter.dynamomapper.DynamoValue</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>       <span class="k">for</span> <span class="o">(..</span><span class="nc">$fromMapParams</span><span class="o">)</span> <span class="k">yield</span> <span class="nc">$companionObj</span><span class="o">(..</span><span class="nc">$names</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;&amp;</span><span class="n">rdquo</span><span class="o">;&amp;</span><span class="n">ldquo</span><span class="o">;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>There are some differences here. We found the companion object for a case class on Line#14 in order to use the <code>apply</code> method. We also used <code>fq</code> when constructing our fields list, as <code>fq</code> is the interpolator for for-loops.</p>

<h2>Summary</h2>

<p>Scala Macros have a reputation for being difficult. They&rsquo;re not. They&rsquo;re just undocumented, and incredibly inconsistent compared to normal Scala code. However, you can use them to provide a nicer experience for developers.</p>

<p>This code has been used successfully in production for over a year now, and is <a href="https://github.com/net-a-porter/dynamo-mapper">available on Github</a> as a library. Please note the warnings on the README, as only some Scala types are supported, and only some DynamoDB types are supported. We didn&rsquo;t have a use-case to implement them all.</p>

<p>Would we write this macro-code again, a year later? Maybe, but maybe not. <a href="https://skillsmatter.com/skillscasts/9294-london-scala-meetup">Chris Birchall did a recent talk on Scala Macros, and Shapeless</a> at the London Scala User&rsquo;s Group, where he argued that anything done with a macro could be done with Shapeless for less effort. Make sure you check out that talk before attempting anything with macros. I also heard very good things about <a href="https://github.com/guardian/scanamo/">the Guardian&rsquo;s Scanamo library</a> at this year&rsquo;s Scala Exchange conference, and it sounds like that would have fulfilled our requirements for a DynamoDB library, had it been published earlier!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Learning Akka Streams]]></title>
    <link href="http://cjwebb.github.io/blog/2016/06/28/learning-akka-streams/"/>
    <updated>2016-06-28T11:00:00+01:00</updated>
    <id>http://cjwebb.github.io/blog/2016/06/28/learning-akka-streams</id>
    <content type="html"><![CDATA[<p>This blog post differs from my usual ones; I&rsquo;m writing it as I learn something. As such, it is more of a story that contains errors and misunderstanding than a factual blog post.</p>

<h2>Hello World</h2>

<p>This blog post follows me trying to learn how to use <a href="http://doc.akka.io/docs/akka/2.4.7/scala/stream/stream-introduction.html">Akka Streams</a>. I haven&rsquo;t needed to use them before, and whenever I glance at the documentation, I usually get confused about just how many new terms are being introduced.</p>

<p>Runnable code is available <a href="https://github.com/cjwebb/blog-code/tree/master/learning-akka-streams">here</a>. I&rsquo;ve included more type annotations that normal, as they will assist us discussing what is going on.</p>

<p>We start by compiling and running the &lsquo;Hello World&rsquo; example in <a href="http://doc.akka.io/docs/akka/2.4.7/scala/stream/stream-quickstart.html#stream-quickstart-scala">the Quick Start Guide</a>.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.NotUsed</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">HelloWorld</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">source</span><span class="o">.</span><span class="n">runForeach</span><span class="o">(</span><span class="n">println</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><code>Source</code> will be widely used. It represents the inputs to the stream.</p>

<p>A couple of things stand out in the code. Firstly, the <code>ActorMaterializer</code> is new, compared to standard Akka. I have no idea what it does, but I&rsquo;m guessing it could have been named &ldquo;ActorFactory&rdquo;.</p>

<p>Secondly, the <code>Source</code> takes two type parameters. The first is the type that the <code>Source</code> emits. The documentations says that &ldquo;the second one may signal that running the source produces some auxiliary value (e.g. a network source may provide information about the bound port or the peerâ€™s address)&rdquo;. The first one makes sense. The second one doesn&rsquo;t yet. Things will hopefully become clearer once I write something else.</p>

<p>Either way, this stream runs and prints out 1 to 100.</p>

<h2>Using a Sink</h2>

<blockquote><p>Source &ndash;> Sink</p></blockquote>

<p>The first example uses a <code>Source</code>. It is not really a Stream. We just send everything to <code>stdout</code>. Let&rsquo;s use <code>Sink</code>, which are the outputs of a stream.</p>

<p>There seem to be lots of kinds of <code>Sink</code>, including a <code>foreach</code> one, which we can use to <code>println</code> again.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">scala.concurrent.Future</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">UsingASink</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">source</span><span class="o">.</span><span class="n">runWith</span><span class="o">(</span><span class="n">sink</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Interestingly, the type signature of this is <code>Sink[Any, Future[Done]]</code>. From reading the ScalaDoc, <code>Done</code> is essentially <code>Unit</code>, but they used included it so the code could also run on Java. We&rsquo;ve also used that second mysterious type parameter.</p>

<p>ScalaDoc says &ldquo;The sink is materialized into a [[scala.concurrent.Future]]&rdquo;. Perhaps the ActorMaterializer has been used, and deals with side-effects? Let&rsquo;s keep going, and see if a more complicated example makes it easier to understand.</p>

<h1>Simple Transform</h1>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source &ndash;> Flow &ndash;> Sink</span></code></pre></td></tr></table></div></figure></p>

<p>So far, we generate a Stream from an <code>Iterable</code>, send it to a <code>Sink</code>, and then print it out. Let&rsquo;s include an intermediate step, where we do some &ldquo;stream processing&rdquo;. For this, we need the <code>Flow</code> class. This is beginning to look more like the Stream I imagined.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">scala.concurrent.Future</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">SimpleTransform</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">helloTimesTen</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="err">&quot;</span><span class="nc">Hello</span> <span class="n">$</span><span class="o">{</span><span class="n">i</span> <span class="o">*</span> <span class="mi">10</span><span class="o">}&amp;</span><span class="n">ldquo</span><span class="o">;)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="n">source</span> <span class="n">via</span> <span class="n">helloTimesTen</span> <span class="n">to</span> <span class="n">sink</span>
</span><span class='line'>  <span class="n">graph</span><span class="o">.</span><span class="n">run</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>We discovered another type now; <code>RunnableGraph</code>. This is a &ldquo;Flow with attached input and output, can be executed.&rdquo;</p>

<p>That makes sense. We&rsquo;ve attached a <code>Source</code>, and a <code>Sink</code>, to our <code>Flow</code>. Therefore it has input and output, and should work.</p>

<p>RunnableGraph also specifies that it has a <code>ClosedShape</code>, which also hints at the role that a <code>Materializer</code> takes. I&rsquo;m still yet to figure them out.
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">/&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'> <span class="o">*</span> <span class="nc">This</span> <span class="o">[[</span><span class="kt">Shape</span><span class="o">]]</span> <span class="n">is</span> <span class="n">used</span> <span class="k">for</span> <span class="n">graphs</span> <span class="n">that</span> <span class="n">have</span> <span class="n">neither</span> <span class="n">open</span> <span class="n">inputs</span> <span class="n">nor</span> <span class="n">open</span>
</span><span class='line'> <span class="o">*</span> <span class="n">outputs</span><span class="o">.</span> <span class="nc">Only</span> <span class="n">such</span> <span class="n">a</span> <span class="o">[[</span><span class="kt">Graph</span><span class="o">]]</span> <span class="n">can</span> <span class="n">be</span> <span class="n">materialized</span> <span class="n">by</span> <span class="n">a</span> <span class="o">[[</span><span class="kt">Materializer</span><span class="o">]].</span>
</span><span class='line'> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;/</span>
</span><span class='line'><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ClosedShape</span> <span class="k">extends</span> <span class="nc">Shape</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Graphs</h2>

<p>All of our examples so far have been very linear. There has been no way of splitting the stream to do different pieces of work, or combine multiple sources.</p>

<p>One use-case I can think of when using Akka Streams is to persist events on the stream to a database, in addition to continuing the stream processing.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source &ndash;> Broadcast &ndash;> Flow &ndash;> Sink
</span><span class='line'>               |
</span><span class='line'>               &ndash;> Save to DB</span></code></pre></td></tr></table></div></figure></p>

<p>Akka Streams has a thing named <code>Broadcast</code> especially for this. However, constructing and using one is more complex than I imaged. You need to start using a mutable <code>GraphDSL.Builder</code>. The GraphDSL implies that we now need to learn what lots of funny symbols mean, such as <code>~&gt;</code>.</p>

<p>We need to build up a <code>Graph[ClosedShape, Mat]</code> where <code>Mat</code> is one of those Materializers that I still don&rsquo;t understand.</p>

<p>Interesting, it seems as though <code>Graph</code> doesn&rsquo;t type-check very well. It is possible to construct and run a Graph that doesn&rsquo;t do anything except fail at runtime. The following code gets checked via a <code>require</code> assertion when running the code:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">isRunnable</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">inPorts</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;</span><span class="n">amp</span><span class="o">;&amp;</span><span class="n">amp</span><span class="o">;</span> <span class="n">outPorts</span><span class="o">.</span><span class="n">isEmpty</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I&rsquo;m not really sure how one would go about asserting this at compile-time. It definitely seems possible though, as other Scala libraries have similar builder patterns that type-check. Hopefully this will be addressed in a future release.</p>

<p>Anyway, lets try and build a Stream that saves events to a DB.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">ExecutionContext</span><span class="o">,</span> <span class="nc">Future</span><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">SendToDB</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">ec</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatcher</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">intSource</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">helloTimesTen</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot;Hello ${i * 10}&amp;ldquo;)</span>
</span><span class='line'><span class="s">  val intToEvent: Flow[Int, DB.Event, NotUsed] = Flow[Int].map(i =&gt; DB.Event(s&quot;</span><span class="nc">Event</span> <span class="nc">$i</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;))&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">printlnSink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">dbSink</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">DB.Event</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="nc">DB</span><span class="o">.</span><span class="n">persistEvent</span><span class="o">).</span><span class="n">toMat</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">right</span><span class="o">).</span><span class="n">named</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">dbSink</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">graph</span> <span class="k">=</span> <span class="nc">RunnableGraph</span><span class="o">.</span><span class="n">fromGraph</span><span class="o">(</span><span class="nc">GraphDSL</span><span class="o">.</span><span class="n">create</span><span class="o">()</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">GraphDSL.Builder</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">import</span> <span class="nn">GraphDSL.Implicits._</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">broadcast</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">Broadcast</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;2&quot;</span><span class="o">&gt;</span><span class="nc">Int</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="n">intSource</span> <span class="o">~&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">broadcast</span> <span class="o">~&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">helloTimesTen</span> <span class="o">~&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">printlnSink</span>
</span><span class='line'>             <span class="n">broadcast</span> <span class="o">~&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">intToEvent</span> <span class="o">~&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="n">dbSink</span>
</span><span class='line'>
</span><span class='line'><span class="nc">ClosedShape</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="o">})&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">graph</span><span class="o">.</span><span class="n">run</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">DB</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Event</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">persistEvent</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Event</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// pretend that some DB IO happens here</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;persisting $e&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="nc">Future</span> <span class="o">{}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>There is a lot of new stuff here. Starting with the easiest thing; I&rsquo;ve renamed some vals to reflect what they do now. We also have a new <code>Flow</code> named <code>intToEvent</code> which maps an <code>Int</code> to a <code>DB.Event</code> case class.</p>

<p>We also have the <code>GraphDSL</code> syntax, and implicit conversions. <code>~&gt;</code> means &ldquo;Add Edge to Graph&rdquo; in my head. As DSLs go, it isn&rsquo;t too bad. Arrows are Stream processing go hand-in-hand. I&rsquo;ll try and use this syntax from now on.
The <code>Broadcast</code> class also checks at compile time that we&rsquo;ve linked all the specified &lsquo;ports&rsquo;. In our example, we create the <code>Broadcast</code> and say it will have two things listening to it. If we only connect, one, we get a runtime error.</p>

<p>Lastly, we have a new <code>Sink</code> named <code>dbSink</code>. I basically copied the code from inside the <code>printlnSink</code> and changed the <code>map</code> method. It seems as though in order to perform actions on a Stream, we need to materialize the values contained inside. I now assume that Streams are inherently lazy, and Materializing is the act of evaluating the Stream.</p>

<p>We need to dig into Materializers, and finally figure them out.</p>

<h2>Basic Materializer</h2>

<p>Having read the docs some more, it seems as though &ldquo;materialization&rdquo; is the thing that actually runs our Stream. When using Akka, actors are created (or materialized) in order to do the work. Makes sense. I can&rsquo;t help but feel that this should have been more obvious at the start&hellip;</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source ~> Sink</span></code></pre></td></tr></table></div></figure></p>

<p>We return to the simplest graph, with just a Source and a Sink. The Source generates Ints, and the Sink just takes the first one.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.NotUsed</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.</span><span class="o">&lt;</span><span class="n">em</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl.</span><span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">scala.concurrent.duration.Duration</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">Await</span><span class="o">,</span> <span class="nc">Future</span><span class="o">}&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">BasicMaterializer</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">intSource</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">headSink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">head</span><span class="o">[</span><span class="kt">Int</span><span class="o">]&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">graph1</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">intSource</span><span class="o">.</span><span class="n">toMat</span><span class="o">(</span><span class="n">headSink</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">right</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">graph2</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span>     <span class="k">=</span> <span class="n">intSource</span><span class="o">.</span><span class="n">toMat</span><span class="o">(</span><span class="n">headSink</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">left</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="c1">// we can only get values from graph1</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">graph1</span><span class="o">.</span><span class="n">run</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">(</span><span class="mi">3</span><span class="o">,&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">seconds</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;))&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">)&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>I&rsquo;ve included code of two RunnableGraphs. They only vary in second arguments; <code>Keep.right</code> versus <code>Keep.left</code>. This seems to be the key to Materializers, and the mysterious second type parameter included everywhere in our Source, Flows, and Sinks.</p>

<p>In order to get any values out of a Stream flowing left to right, we need to keep the right values. Presumably, in a stream going the other way, we need to keep the left values. In our case, the right side of our graph has <code>Future[Int]</code> as the second type parameter. This is the one we need.</p>

<p>The types on these methods are very obvious; given two types select the one on the left, or the right.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">left</span> <span class="o">[</span><span class="kt">L</span>, <span class="kt">R</span><span class="o">]</span><span class="k">:</span> <span class="o">(</span><span class="kt">L</span><span class="o">,</span> <span class="kt">R</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">L</span>
</span><span class='line'><span class="k">def</span> <span class="n">right</span><span class="o">[</span><span class="kt">L</span>, <span class="kt">R</span><span class="o">]</span><span class="k">:</span> <span class="o">(</span><span class="kt">L</span><span class="o">,</span> <span class="kt">R</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">R</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>This now also answers my questions above about the previously used <code>Sink</code> named <code>dbSink</code>. Here&rsquo;s the implementation again:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span><span class="kt">DB.Event</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="nc">DB</span><span class="o">.</span><span class="n">persistEvent</span><span class="o">).</span><span class="n">toMat</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">right</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p><code>DB.persistEvent</code> returns a <code>Future[Unit]</code>. In order to actually evalutate these Futures, we need to materialize the stream. As we&rsquo;re Keeping right, we pass our futures into <code>Sink.ignore</code>. If we kept left, we pass <code>NotUsed</code>. Whilst ignoring them doesn&rsquo;t sound very useful, this actually runs them before ignoring whatever they return.</p>

<p>I feel like I understand roughly how Akka Streams work now.</p>

<p>Here&rsquo;s a recap.</p>

<ul>
<li>Sources generate values.</li>
<li>Sinks consume values.</li>
<li>Materialization is the process of running the Stream, and getting your Sink to do something.</li>
<li>Flows are linear transformations.</li>
<li>Graphs can be modelled with Broadcast (and Merge, but we didn&rsquo;t try them out).</li>
</ul>


<p>This is enough blog post for now. I&rsquo;d like to continue learning Akka Streams; they seem a lot easier to use than Actors, and patterns are built in. Streams are more type-safe than Actors too, which hopefully will permit writing more maintainable code.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Play-Framework's PathBindable]]></title>
    <link href="http://cjwebb.github.io/blog/2015/06/23/play-framework-path-binders/"/>
    <updated>2015-06-23T19:45:00+01:00</updated>
    <id>http://cjwebb.github.io/blog/2015/06/23/play-framework-path-binders</id>
    <content type="html"><![CDATA[<p>Using custom types in <a href="https://www.playframework.com/documentation/2.4.x/ScalaRouting">Play Frameworkâ€™s routes file</a> is a major win, and is not something obviously supported. Consider the routes file below:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">GET</span> <span class="o">/</span><span class="n">stuff</span><span class="o">/:</span><span class="n">id</span>     <span class="nd">@controllers</span><span class="o">.</span><span class="nc">StuffController</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="nc">GET</span> <span class="o">/</span><span class="n">things</span><span class="o">/:</span><span class="n">id</span>    <span class="nd">@controllers</span><span class="o">.</span><span class="nc">ThingsController</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">java.util.UUID</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>In the first route, we take the id parameter as a String. In the second, we take it as a <code>java.util.UUID</code>.</p>

<h2>Advantages</h2>

<p>In our example above, paths that do not contains UUIDs are not matched for the second route. We donâ€™t have to deal with IDs that are not UUIDs.</p>

<p>At the start of a project, you may see lots of lines that say:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">id</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">case</span> <span class="n">i</span> <span class="k">if</span> <span class="n">isUUID</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">doStuff</span><span class="o">()</span>
</span><span class='line'>   <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">BadRequest</span><span class="o">(</span><span class="err">â€œ</span><span class="n">id</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="nc">UUID</span><span class="err">â€</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>By not matching on the route, we can remove this code. A request either matches a route, and is passed to the controller, or it doesnâ€™t, and the controller never knows about the request.</p>

<p>By allowing types, and not just strings, you can avoid <a href="http://c2.com/cgi/wiki?StringlyTyped">stringly-typed</a> controllers. Admittedly, UUIDly-typed is only a small step in the right direction, but still a significant improvement.</p>

<h2>Disadvantages</h2>

<p>You need to fully-qualify the types in the routes file, for example by using <code>java.util.UUID</code> everywhere. You cannot use imports in the routes file. Hopefully someone will find a solution to that at some point.</p>

<h2>Implementation</h2>

<p>There are two things that need doing before you can use custom types in the routes file. Firstly, you must implement a <code>PathBindable</code> and its <code>bind</code> and <code>unbind</code> methods. For a UUID, this is quite simple. The <code>bind</code> method returns an <code>Either</code> so that you can return the a message for why the route did not match.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">util</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">import</span> <span class="nn">java.util.UUID</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.mvc.PathBindable</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">object</span> <span class="nc">Binders</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">implicit</span> <span class="k">def</span> <span class="n">uuidPathBinder</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PathBindable</span><span class="o">[</span><span class="kt">UUID</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">bind</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">UUID</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="nc">Right</span><span class="o">(</span><span class="nc">UUID</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">value</span><span class="o">))</span>
</span><span class='line'>         <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">IllegalArgumentException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="nc">Id</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="nc">UUID</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;)</span>
</span><span class='line'>         <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">unbind</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>Secondly, you must make Play aware of this class, by changing your build file.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.PlayImport.PlayKeys._&lt;/p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">routesImport</span> <span class="o">+=</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">utils</span><span class="o">.</span><span class="nc">Binders</span><span class="o">.</span><span class="k">_</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>After those two steps, you can then use types in the routes file.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ScalaTest and Twitter Futures]]></title>
    <link href="http://cjwebb.github.io/blog/2015/02/02/scalatest-futures/"/>
    <updated>2015-02-02T19:45:00+00:00</updated>
    <id>http://cjwebb.github.io/blog/2015/02/02/scalatest-futures</id>
    <content type="html"><![CDATA[<p>Scala has nice abstractions for asynchronous code. However, writing tests for that code sometimes results in an ugly, unreadable mess. Fortunately, ScalaTest has built-in support for testing Futures, in addition to utilities for other types of asynchronous testing, such as polling and test-probes.</p>

<h2>org.scalatest.concurrent.Futures</h2>

<p>ScalaTest has <a href="http://doc.scalatest.org/2.0/#org.scalatest.concurrent.Futures">a trait named Futures</a> which defines functions such as <code>whenReady</code>, and other goodies like a <code>futureValue</code> method to help your async tests become terser. However, ScalaTest only comes with support for the standard-library Futures. To use them, mixin <code>org.scalatest.concurrent.ScalaFutures</code>.</p>

<p>If, currently like me, you&rsquo;re using <a href="https://twitter.github.io/finagle/guide/Futures.html#futures">Twitter Futures</a>, then you need to define your own support for them. Luckily, it is quite easy to define support for any Futures library.</p>

<p>Behold a TwitterFutures trait:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">com.twitter.util.</span><span class="o">{</span><span class="nc">Throw</span><span class="o">,</span> <span class="nc">Return</span><span class="o">}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.concurrent.Futures</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="k">trait</span> <span class="nc">TwitterFutures</span> <span class="k">extends</span> <span class="nc">Futures</span> <span class="o">{&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">import</span> <span class="nn">scala.language.implicitConversions</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">convertTwitterFuture</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s">&quot;twitterFuture:%20com.twitter.util.Future[T]&quot;</span><span class="o">&gt;</span><span class="n">T</span><span class="o">&lt;/</span><span class="n">a</span><span class="k">&gt;:</span> <span class="nc">FutureConcept</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">FutureConcept</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">eitherValue</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">twitterFuture</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nc">Return</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="n">o</span><span class="o">)</span>
</span><span class='line'>          <span class="k">case</span> <span class="nc">Throw</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">isCanceled</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">isExpired</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>You may also have to define an implicit <code>PatienceConfig</code> for your tests as the default settings will timeout after 150 milliseconds.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">asyncConfig</span> <span class="k">=</span> <span class="nc">PatienceConfig</span><span class="o">(</span><span class="n">timeout</span> <span class="k">=</span> <span class="n">scaled</span><span class="o">(</span><span class="nc">Span</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Polling?</h2>

<p>Strangely, ScalaTest chooses to poll futures, despite both Scala and Twitter Futures coming with <code>Await</code> functions that handle timeouts. Using that as a starting point would have seemed more sensible to me. However, I&rsquo;m not the author of a successful Scala testing library, and I&rsquo;m sure that author <a href="http://twitter.com/bvenners">Bill Venners</a> had a reason. However, it is worth noting.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Monoids]]></title>
    <link href="http://cjwebb.github.io/blog/2014/10/02/monoids/"/>
    <updated>2014-10-02T22:00:00+01:00</updated>
    <id>http://cjwebb.github.io/blog/2014/10/02/monoids</id>
    <content type="html"><![CDATA[<blockquote><p>In abstract algebra, a branch of mathematics, a monoid is an algebraic structure with a single associative binary operation and an identity element. Monoids are studied in semigroup theory as they are semigroups with identity.</p></blockquote>

<p><a href="http://en.wikipedia.org/wiki/Monoid">Wikipedia has the above definition of a Monoid</a>. This blog post will desconstruct that definition to simply describe what a monoid is, and why you would want to use one.</p>

<p>We will, however, ignore a proper defintion of &lsquo;abstract algebra&rsquo; as that would mean writing several textbooks. Just imagine an &lsquo;algebraic structure&rsquo; as a thing that contains functions. A &lsquo;thing that contains functions&rsquo; is sometimes named a class in programming languages.</p>

<p>So, with that out of the way, this is the list of things we will cover:</p>

<ul>
<li>Associative</li>
<li>Semigroup</li>
<li>Identity</li>
</ul>


<h2>Associative</h2>

<p>You should have learnt some associative things during Mathematics lessons at primary school. Addition and Multiplication are associative. Subtraction and Division are not. Associativity means that you can reorder operations on a list of things, and always receive the same result.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">((((</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">)</span> <span class="o">+</span> <span class="mi">4</span><span class="o">)</span> <span class="o">+</span> <span class="mi">5</span><span class="o">)</span> <span class="k">=</span> <span class="mi">15</span>
</span><span class='line'><span class="o">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">(</span><span class="mi">2</span> <span class="o">+</span> <span class="o">(</span><span class="mi">3</span> <span class="o">+</span> <span class="o">(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">5</span><span class="o">))))</span> <span class="k">=</span> <span class="mi">15</span> <span class="c1">// reordered, same result</span>
</span><span class='line'><span class="o">((((</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">)</span> <span class="o">-</span> <span class="mi">4</span><span class="o">)</span> <span class="o">-</span> <span class="mi">5</span><span class="o">)</span> <span class="k">=</span> <span class="o">-</span><span class="mi">13</span>
</span><span class='line'><span class="o">(</span><span class="mi">1</span> <span class="o">-</span> <span class="o">(</span><span class="mi">2</span> <span class="o">-</span> <span class="o">(</span><span class="mi">3</span> <span class="o">-</span> <span class="o">(</span><span class="mi">4</span> <span class="o">-</span> <span class="mi">5</span><span class="o">))))</span> <span class="k">=</span> <span class="mi">3</span> <span class="c1">// reordered, different result</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Semigroup</h2>

<p>Semigroup is the name for a thing that provides an associative function. For Integers, <code>+</code> and <code>*</code> are associative functions. A Semigroup is one of those &ldquo;algebraic structures&rdquo;, and it has one function; an associative one.</p>

<p>It would looks like this, for adding up Integers:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">AdditionSemigroup</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">associative</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>It is worth noting that a Semigroup will apply to a whole type. This Semigroup will apply to all <code>Int</code>, as denoted by the square brackets after the class name. The example is written in Scala, where <code>Int</code> is an alias for <code>Integer</code>.</p>

<h2>Identity</h2>

<p>Also known as the zero value, or the &lsquo;value for which nothing happens&rsquo;. This will depend on what your monoid does. For instance, for an adding monoid, the identity value will be zero. Adding zero to <code>x</code> gives you <code>x</code>. For multiplication, the identity value will be 1. Multiplying 1 by <code>x</code> gives you <code>x</code>. If we had kept the identity value as zero, multiplying <code>x</code> by zero would return zero, thereby being useless. Likewise, any other value would mess up our calculation.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span>     <span class="k">=</span> <span class="mi">2</span>
</span><span class='line'><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">0</span> <span class="k">=</span> <span class="mi">2</span> <span class="c1">// we can add an &amp;lsquo;identity&amp;rsquo; of zero at any point</span>
</span><span class='line'><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span>     <span class="k">=</span> <span class="mi">16</span>
</span><span class='line'><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1</span> <span class="k">=</span> <span class="mi">16</span> <span class="c1">// we can add an &amp;lsquo;identity&amp;rsquo; of 1 at any point.</span>
</span><span class='line'><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">0</span> <span class="k">=</span> <span class="mi">0</span>  <span class="c1">// an &amp;lsquo;identity&amp;rsquo; of zero doesn&amp;rsquo;t work for multiplication</span>
</span><span class='line'><span class="mi">4</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">2</span> <span class="k">=</span> <span class="mi">32</span> <span class="c1">// neither does any other value. It has to be 1!</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>So what is a monoid?</h2>

<p>A monoid, has an associative function, and it has an identity function. As you may be able to tell from the wikipedia description, it really is a Semigroup, but with an identity function.</p>

<p>As shown above, the <code>+</code> operator on Integers is associative, and we know that the zero value for this is <code>0</code></p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">AdditionMonoid</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">identity</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">associative</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">b</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></p>

<h2>Why is this useful?</h2>

<p>Consider the following Scala example. <code>|+|</code> is an alias for our previously-seen associative method. This particular associative method (<a href="https://github.com/scalaz/scalaz/blob/49b235695f1d3ae3217a70b419cbb33337f31ade/core/src/main/scala/scalaz/std/Map.scala#L113">taken from scalaz</a>) merges two Maps together by summing the values if the keys are equal.</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">scalaz.Scalaz._</span> <span class="c1">// this defines the |+| operator.</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Map</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="mf">1.0</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="mf">3.0</span><span class="o">)</span> <span class="o">|+|</span> <span class="nc">Map</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">)</span>
</span><span class='line'><span class="n">res0</span><span class="k">:</span> <span class="kt">scala.collection.immutable.Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="mf">0.0</span><span class="o">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="mf">3.0</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>We can also take advantage of the <code>reduce</code> method to do this:</p>

<p><figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="nc">Map</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="mf">1.0</span><span class="o">,</span> <span class="o">&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">b</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="mf">3.0</span><span class="o">),</span> <span class="nc">Map</span><span class="o">(&amp;</span><span class="n">ldquo</span><span class="o">;</span><span class="n">a</span><span class="o">&amp;</span><span class="n">rdquo</span><span class="o">;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">)).</span><span class="n">reduce</span><span class="o">(&lt;</span><span class="n">em</span><span class="o">&gt;</span> <span class="o">|+|</span> <span class="o">&lt;/</span><span class="n">em</span><span class="o">&gt;)</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">scala.collection.immutable.Map</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="mf">0.0</span><span class="o">,</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="mf">3.0</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure></p>

<p>If you can define your problem as a Monoid, it becomes trivial to compute, and trivial to parallelise too. Remember, associative functions can be batched and executed in any order.</p>

<p>Hopefully it is becoming clear why this is useful. If you want to add Integers together, most languages already include basic addition. However, Monoids can potentially be written for any type of data. As long as you define <code>identity</code> and <code>associative</code>, they can do anything you want!</p>
]]></content>
  </entry>
  
</feed>
