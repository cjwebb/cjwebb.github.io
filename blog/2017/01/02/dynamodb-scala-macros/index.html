
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DynamoDB with Scala Macros - cjwebb.github.io</title>
  <meta name="author" content="Colin Webb">

  
  <meta name="description" content="I&rsquo;ve spent the last year using AWS DynamoDB at work. When we initially searched for a Scala client for DynamoDB, we had the following criteria &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="cjwebb.github.io" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41253515-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">cjwebb.github.io</a></h1>
  
    <h2>I write software, teach people, and investigate new technology</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cjwebb.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">DynamoDB With Scala Macros</h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-01-02T11:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I&rsquo;ve spent the last year using <a href="https://aws.amazon.com/documentation/dynamodb/">AWS DynamoDB</a> at work. When we initially searched for a Scala client for DynamoDB, we had the following criteria:</p>

<ul>
<li>Good for Scala beginners</li>
<li>Up to date</li>
<li>Well documented</li>
</ul>


<p>Sadly, none of the Scala libraries available at that time matched all three criteria. The most up-to-date libraries were not suitable for a team starting out with Scala and DynamoDB. The most beginner-friendly libraries were out-of-date, and most only had superficial documentation.</p>

<p>The closest to matching all three criteria was the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.Java.html">official AWS SDK</a>, but it was written in Java. We used eventually used a thin layer of Scala Macros to make it nicer to use for Scala beginners, and experts alike.</p>

<h2>Plain Old Java DynamoDB API</h2>

<p>The Java DynamoDB SDK is not pleasant to use. There is a lot of boilerplate.</p>

<p>In order to do simple inserts, you must construct a <code>java.util.Map[String, AttributeValue]</code>. For a simple case class, this conversion is simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">SimpleCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">format</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">SimpleCaseClass</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Map</span> <span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">asJava</span>
</span></code></pre></td></tr></table></div></figure>


<p>For nested case classes, this gets ugly.
In order to place a nested structure into DynamoDB, you must construct another map of <code>AttributeValue</code> inside of a <code>AttributeValue().withM</code>, where <code>withM</code> means <code>withMap</code>. DynamoDB has a few abbreviations like <code>M</code>, <code>N</code>, <code>S</code>, which are the type of data you&rsquo;re sending to Dynamo. <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html">You can read the full list on the official docs</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">SimpleCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">NestedCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">simple</span><span class="k">:</span> <span class="kt">SimpleCaseClass</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">NestedCaseClass</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Map</span> <span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;simple&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">().</span><span class="n">withM</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">nestedId</span><span class="o">),</span>
</span><span class='line'>    <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="s">&quot;simple&quot;</span><span class="o">)</span>
</span><span class='line'>   <span class="o">).</span><span class="n">asJava</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">asJava</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m sure you can imagine how tiresome writing this type of code became. We wrote a macro to generate this boilerplate for us.</p>

<h2>Don&rsquo;t Write Macros</h2>

<blockquote><p>The first rule of macro club is don&rsquo;t write macros</p></blockquote>

<p>Macros are confusing. Using a macro means you write your code, the macro rewrites it, and then we execute the code without really knowing what the code now looks like. Macros can make code more complicated, and should be avoided in most situations.</p>

<blockquote><p>The second rule of macro club is to write the simplest macro possible.</p></blockquote>

<p>I made this one up, but I like it. If you <em>have</em> to write a macro, write one so simple that anyone can understand how it works. Write one that is so simple that it can be explained in a blog post!</p>

<h2>An Intermediate Representation</h2>

<p>Following the second rule of macro club, we defined some simple functions and typeclasses that simplified the macro. This also had the advantage of yielding more control than a macro did.</p>

<p>For instance, we wanted better control over the AttributeValue key names, so we defined <code>DynamoWrites</code> and <code>DynamoReads</code>. As we use Play Framework a lot, they were heavily influenced by Play JSON Writes and Reads. <code>DynamoReadResult</code> was inspired by Play JSON&rsquo;s <code>JsResult</code>. The only difference is that this <code>DynamoReads</code> code fails fast rather than using an applicative to collect all the errors.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">writeFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoWrites</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DynamoValue</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">map</span><span class="o">(</span><span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">readFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoReads</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">DynamoValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">DynamoReadResult</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">id</span>    <span class="k">&lt;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="n">name</span>  <span class="k">&lt;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="n">email</span> <span class="k">&lt;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">email</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With these defined, writing the macros was simpler, and we have a nicer representation than the Java SDK to fallback to if the macro doesn&rsquo;t quite meet our needs.</p>

<h2>Macros Explained!</h2>

<p>Below is a macro. It generates a <code>DynamoWrites</code> implementation for a case class:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">formatWriteImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">whitebox.Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">c.universe._</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">toMapParams</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toTermName</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>    <span class="n">q</span><span class="s">&quot;($decoded -&gt; o.$name)&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">    new _root_.com.netaporter.dynamomapper.DynamoWrites[$tpe] {</span>
</span><span class='line'><span class="s">      override def writes(o: $tpe) = map(..$toMapParams)</span>
</span><span class='line'><span class="s">    }</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It doesn&rsquo;t look simple though! Let&rsquo;s break it down. Scala macros contain <strong>a lot</strong> of boilerplate. However, this is boilerplate that we only had to write once, rather than every time we wanted to convert a case class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">formatWriteImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">whitebox.Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line (above) is the type signature. Crucially, it finishes with <code>c.Expr[DynamoWrites[T]]</code>. This means we return an <code>Expression</code> of <code>DynamoWrites[T]</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'><span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we have some typelevel programming. <code>tpe</code> enabled us to query the type of <code>T</code>. Types expose declarations (or <code>decls</code>), such as their constructors, methods, variables etc. This code finds the constructor, and gets the fields we need to provide in order to instantiate an instance of the case class. For the <code>DynamoWrites</code>, we need to know what the type is expecting in order to write it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">toMapParams</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toTermName</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>  <span class="n">q</span><span class="s">&quot;($decoded -&gt; o.$name)&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>toMapParams</code> maps over the fields and returns a map of names to values contained in an a type. <code>decoded</code> is the string name of the field, and <code>o.$name</code> invokes the that field on an object <code>o</code>. This object is provided by the implementation of the <code>DynamoWrites</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">  new _root_.com.netaporter.dynamomapper.DynamoWrites[$tpe] {</span>
</span><span class='line'><span class="s">    override def writes(o: $tpe) = map(..$toMapParams)</span>
</span><span class='line'><span class="s">  }</span>
</span><span class='line'><span class="s">  &quot;&quot;&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where the magic happens. We use quasiquotes to create our <code>DynamoWrites[T]</code>, and specify that <code>o</code> is type <code>T</code>. Quasiquotes are essentially string interpolation, with <a href="http://docs.scala-lang.org/overviews/quasiquotes/expression-details.html">various notations</a>. We inserted our previously constructed field-map using the <code>..$</code> notation. The double-dots denote that we passed a list.</p>

<h2>Macros Again!</h2>

<p>We still needed a macro for <code>DynamoReads</code>. Luckily, it is almost the same as before. Copy paste, with a few alterations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.language.higherKinds</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.reflect.macros._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.language.experimental.macros</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">formatReadImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">whitebox.Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoReads</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">c.universe._</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">companionObj</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">typeSymbol</span><span class="o">.</span><span class="n">companion</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="o">(</span><span class="n">names</span><span class="o">,</span> <span class="n">fromMapParams</span><span class="o">)</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">asTerm</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">returnType</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decl</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="n">typeSignature</span>
</span><span class='line'>    <span class="o">(</span><span class="n">q</span><span class="s">&quot;$name&quot;</span><span class="o">,</span> <span class="n">fq</span><span class="s">&quot;&quot;&quot;$name &lt;- o.attr[$returnType]($decoded)&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">unzip</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoReads</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">    new _root_.com.netaporter.dynamomapper.DynamoReads[$tpe] {</span>
</span><span class='line'><span class="s">      override def reads(o: _root_.com.netaporter.dynamomapper.DynamoValue) =</span>
</span><span class='line'><span class="s">       for (..$fromMapParams) yield $companionObj(..$names)</span>
</span><span class='line'><span class="s">    }</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are some differences here. We found the companion object for a case class on Line#14 in order to use the <code>apply</code> method. We also used <code>fq</code> when constructing our fields list, as <code>fq</code> is the interpolator for for-loops.</p>

<h2>Summary</h2>

<p>Scala Macros have a reputation for being difficult. They&rsquo;re not. They&rsquo;re just undocumented, and incredibly inconsistent compared to normal Scala code. However, you can use them to provide a nicer experience for developers.</p>

<p>This code has been used successfully in production for over a year now, and is <a href="https://github.com/net-a-porter/dynamo-mapper">available on Github</a> as a library. Please note the warnings on the README, as only some Scala types are supported, and only some DynamoDB types are supported. We didn&rsquo;t have a use-case to implement them all.</p>

<p>Would we write this macro-code again, a year later? Maybe, but maybe not. <a href="https://skillsmatter.com/skillscasts/9294-london-scala-meetup">Chris Birchall did a recent talk on Scala Macros, and Shapeless</a> at the London Scala User&rsquo;s Group, where he argued that anything done with a macro could be done with Shapeless for less effort. Make sure you check out that talk before attempting anything with macros. I also heard very good things about <a href="https://github.com/guardian/scanamo/">the Guardian&rsquo;s Scanamo library</a> at this year&rsquo;s Scala Exchange conference, and it sounds like that would have fulfilled our requirements for a DynamoDB library, had it been published earlier!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Colin Webb</span></span>

      








  


<time datetime="2017-01-02T11:00:00+00:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/database/'>database</a>, <a class='category' href='/blog/categories/scala/'>scala</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros/" data-via="colinjameswebb" data-counturl="http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros/" >Tweet</a>
  
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016/12/16/getting-started-with-haskells-warp/" title="Previous Post: Getting Started with Haskell's Warp">&laquo; Getting Started with Haskell's Warp</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/01/02/dynamodb-scala-macros/">DynamoDB With Scala Macros</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/16/getting-started-with-haskells-warp/">Getting Started With Haskell's Warp</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/28/learning-akka-streams/">Learning Akka Streams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/15/the-virtues-of-side-projects/">The Virtues of Side Projects</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/01/elm-in-octopress/">Using Elm in Octopress</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>My name is Colin Webb, and I'm a software consultant.</p>
  <p>I write software, teach people, and investigate new technology.</p>

  <p>You can find me on Twitter <a href="http://twitter.com/colinjwebb">@colinjwebb</a>, or generally online at <a href="http://colinjameswebb.com">colinjameswebb.com</a></p>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Colin Webb -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cjwebbgithubio';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros/';
        var disqus_url = 'http://cjwebb.github.io/blog/2017/01/02/dynamodb-scala-macros/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
