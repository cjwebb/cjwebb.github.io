
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>cjwebb.github.io</title>
  <meta name="author" content="Colin Webb">

  
  <meta name="description" content="I&rsquo;ve spent the last year using AWS DynamoDB at work. When we initially searched for a Scala client for DynamoDB, we had the following criteria &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://cjwebb.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="cjwebb.github.io" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41253515-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">cjwebb.github.io</a></h1>
  
    <h2>I write software, teach people, and investigate new technology</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:cjwebb.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/01/02/dynamodb-scala-macros/">DynamoDB With Scala Macros</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-01-02T11:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2017/01/02/dynamodb-scala-macros/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve spent the last year using <a href="https://aws.amazon.com/documentation/dynamodb/">AWS DynamoDB</a> at work. When we initially searched for a Scala client for DynamoDB, we had the following criteria:</p>

<ul>
<li>Good for Scala beginners</li>
<li>Up to date</li>
<li>Well documented</li>
</ul>


<p>Sadly, none of the Scala libraries available at that time matched all three criteria. The most up-to-date libraries were not suitable for a team starting out with Scala and DynamoDB. The most beginner-friendly libraries were out-of-date, and most only had superficial documentation.</p>

<p>The closest to matching all three criteria was the <a href="https://docs.aws.amazon.com/amazondynamodb/latest/gettingstartedguide/GettingStarted.Java.html">official AWS SDK</a>, but it was written in Java. We used eventually used a thin layer of Scala Macros to make it nicer to use for Scala beginners, and experts alike.</p>

<h2>Plain Old Java DynamoDB API</h2>

<p>The Java DynamoDB SDK is not pleasant to use. There is a lot of boilerplate.</p>

<p>In order to do simple inserts, you must construct a <code>java.util.Map[String, AttributeValue]</code>. For a simple case class, this conversion is simple:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">SimpleCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">format</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">SimpleCaseClass</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Map</span> <span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">asJava</span>
</span></code></pre></td></tr></table></div></figure>


<p>For nested case classes, this gets ugly.
In order to place a nested structure into DynamoDB, you must construct another map of <code>AttributeValue</code> inside of a <code>AttributeValue().withM</code>, where <code>withM</code> means <code>withMap</code>. DynamoDB has a few abbreviations like <code>M</code>, <code>N</code>, <code>S</code>, which are the type of data you&rsquo;re sending to Dynamo. <a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/DynamoDBMapper.DataTypes.html">You can read the full list on the official docs</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">SimpleCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">NestedCaseClass</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">simple</span><span class="k">:</span> <span class="kt">SimpleCaseClass</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">format</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">NestedCaseClass</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Map</span> <span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;simple&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">().</span><span class="n">withM</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="n">nestedId</span><span class="o">),</span>
</span><span class='line'>    <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">AttributeValue</span><span class="o">(</span><span class="s">&quot;simple&quot;</span><span class="o">)</span>
</span><span class='line'>   <span class="o">).</span><span class="n">asJava</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">asJava</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m sure you can imagine how tiresome writing this type of code became. We wrote a macro to generate this boilerplate for us.</p>

<h2>Don&rsquo;t Write Macros</h2>

<blockquote><p>The first rule of macro club is don&rsquo;t write macros</p></blockquote>

<p>Macros are confusing. Using a macro means you write your code, the macro rewrites it, and then we execute the code without really knowing what the code now looks like. Macros can make code more complicated, and should be avoided in most situations.</p>

<blockquote><p>The second rule of macro club is to write the simplest macro possible.</p></blockquote>

<p>I made this one up, but I like it. If you <em>have</em> to write a macro, write one so simple that anyone can understand how it works. Write one that is so simple that it can be explained in a blog post!</p>

<h2>An Intermediate Representation</h2>

<p>Following the second rule of macro club, we defined some simple functions and typeclasses that simplified the macro. This also had the advantage of yielding more control than a macro did.</p>

<p>For instance, we wanted better control over the AttributeValue key names, so we defined <code>DynamoWrites</code> and <code>DynamoReads</code>. As we use Play Framework a lot, they were heavily influenced by Play JSON Writes and Reads. <code>DynamoReadResult</code> was inspired by Play JSON&rsquo;s <code>JsResult</code>. The only difference is that this <code>DynamoReads</code> code fails fast rather than using an applicative to collect all the errors.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">writeFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoWrites</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">u</span><span class="k">:</span> <span class="kt">User</span><span class="o">)</span><span class="k">:</span> <span class="kt">DynamoValue</span> <span class="o">=</span>
</span><span class='line'>    <span class="n">map</span><span class="o">(</span><span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">name</span><span class="o">,</span> <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">email</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">readFormat</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">DynamoReads</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">d</span><span class="k">:</span> <span class="kt">DynamoValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">DynamoReadResult</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">id</span>    <span class="k">&lt;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;id&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="n">name</span>  <span class="k">&lt;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;name&quot;</span><span class="o">)</span>
</span><span class='line'>      <span class="n">email</span> <span class="k">&lt;-</span> <span class="n">d</span><span class="o">.</span><span class="n">attr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="s">&quot;email&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="nc">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">,</span> <span class="n">email</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With these defined, writing the macros was simpler, and we have a nicer representation than the Java SDK to fallback to if the macro doesn&rsquo;t quite meet our needs.</p>

<h2>Macros Explained!</h2>

<p>Below is a macro. It generates a <code>DynamoWrites</code> implementation for a case class:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">formatWriteImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">whitebox.Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">c.universe._</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">toMapParams</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toTermName</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>    <span class="n">q</span><span class="s">&quot;($decoded -&gt; o.$name)&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">    new _root_.com.netaporter.dynamomapper.DynamoWrites[$tpe] {</span>
</span><span class='line'><span class="s">      override def writes(o: $tpe) = map(..$toMapParams)</span>
</span><span class='line'><span class="s">    }</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It doesn&rsquo;t look simple though! Let&rsquo;s break it down. Scala macros contain <strong>a lot</strong> of boilerplate. However, this is boilerplate that we only had to write once, rather than every time we wanted to convert a case class.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">formatWriteImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">whitebox.Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first line (above) is the type signature. Crucially, it finishes with <code>c.Expr[DynamoWrites[T]]</code>. This means we return an <code>Expression</code> of <code>DynamoWrites[T]</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'><span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we have some typelevel programming. <code>tpe</code> enabled us to query the type of <code>T</code>. Types expose declarations (or <code>decls</code>), such as their constructors, methods, variables etc. This code finds the constructor, and gets the fields we need to provide in order to instantiate an instance of the case class. For the <code>DynamoWrites</code>, we need to know what the type is expecting in order to write it.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">toMapParams</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">toTermName</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>  <span class="n">q</span><span class="s">&quot;($decoded -&gt; o.$name)&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>toMapParams</code> maps over the fields and returns a map of names to values contained in an a type. <code>decoded</code> is the string name of the field, and <code>o.$name</code> invokes the that field on an object <code>o</code>. This object is provided by the implementation of the <code>DynamoWrites</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoWrites</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">  new _root_.com.netaporter.dynamomapper.DynamoWrites[$tpe] {</span>
</span><span class='line'><span class="s">    override def writes(o: $tpe) = map(..$toMapParams)</span>
</span><span class='line'><span class="s">  }</span>
</span><span class='line'><span class="s">  &quot;&quot;&quot;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is where the magic happens. We use quasiquotes to create our <code>DynamoWrites[T]</code>, and specify that <code>o</code> is type <code>T</code>. Quasiquotes are essentially string interpolation, with <a href="http://docs.scala-lang.org/overviews/quasiquotes/expression-details.html">various notations</a>. We inserted our previously constructed field-map using the <code>..$</code> notation. The double-dots denote that we passed a list.</p>

<h2>Macros Again!</h2>

<p>We still needed a macro for <code>DynamoReads</code>. Luckily, it is almost the same as before. Copy paste, with a few alterations.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.language.higherKinds</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.reflect.macros._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.language.experimental.macros</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">formatReadImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c.WeakTypeTag</span><span class="o">](</span><span class="n">c</span><span class="k">:</span> <span class="kt">whitebox.Context</span><span class="o">)</span><span class="k">:</span> <span class="kt">c.Expr</span><span class="o">[</span><span class="kt">DynamoReads</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">c.universe._</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">tpe</span> <span class="k">=</span> <span class="n">weakTypeOf</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">fields</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decls</span><span class="o">.</span><span class="n">collectFirst</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">m</span><span class="k">:</span> <span class="kt">MethodSymbol</span> <span class="kt">if</span> <span class="kt">m.isPrimaryConstructor</span> <span class="o">=&gt;</span> <span class="n">m</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">get</span><span class="o">.</span><span class="n">paramLists</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">companionObj</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">typeSymbol</span><span class="o">.</span><span class="n">companion</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="o">(</span><span class="n">names</span><span class="o">,</span> <span class="n">fromMapParams</span><span class="o">)</span> <span class="k">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="n">field</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">field</span><span class="o">.</span><span class="n">asTerm</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">decoded</span> <span class="k">=</span> <span class="n">name</span><span class="o">.</span><span class="n">decodedName</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">returnType</span> <span class="k">=</span> <span class="n">tpe</span><span class="o">.</span><span class="n">decl</span><span class="o">(</span><span class="n">name</span><span class="o">).</span><span class="n">typeSignature</span>
</span><span class='line'>    <span class="o">(</span><span class="n">q</span><span class="s">&quot;$name&quot;</span><span class="o">,</span> <span class="n">fq</span><span class="s">&quot;&quot;&quot;$name &lt;- o.attr[$returnType]($decoded)&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">unzip</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">DynamoReads</span><span class="o">[</span><span class="kt">T</span><span class="o">]]</span> <span class="o">{</span> <span class="n">q</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">    new _root_.com.netaporter.dynamomapper.DynamoReads[$tpe] {</span>
</span><span class='line'><span class="s">      override def reads(o: _root_.com.netaporter.dynamomapper.DynamoValue) =</span>
</span><span class='line'><span class="s">       for (..$fromMapParams) yield $companionObj(..$names)</span>
</span><span class='line'><span class="s">    }</span>
</span><span class='line'><span class="s">    &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are some differences here. We found the companion object for a case class on Line#14 in order to use the <code>apply</code> method. We also used <code>fq</code> when constructing our fields list, as <code>fq</code> is the interpolator for for-loops.</p>

<h2>Summary</h2>

<p>Scala Macros have a reputation for being difficult. They&rsquo;re not. They&rsquo;re just undocumented, and incredibly inconsistent compared to normal Scala code. However, you can use them to provide a nicer experience for developers.</p>

<p>This code has been used successfully in production for over a year now, and is <a href="https://github.com/net-a-porter/dynamo-mapper">available on Github</a> as a library. Please note the warnings on the README, as only some Scala types are supported, and only some DynamoDB types are supported. We didn&rsquo;t have a use-case to implement them all.</p>

<p>Would we write this macro-code again, a year later? Maybe, but maybe not. <a href="https://skillsmatter.com/skillscasts/9294-london-scala-meetup">Chris Birchall did a recent talk on Scala Macros, and Shapeless</a> at the London Scala User&rsquo;s Group, where he argued that anything done with a macro could be done with Shapeless for less effort. Make sure you check out that talk before attempting anything with macros. I also heard very good things about <a href="https://github.com/guardian/scanamo/">the Guardian&rsquo;s Scanamo library</a> at this year&rsquo;s Scala Exchange conference, and it sounds like that would have fulfilled our requirements for a DynamoDB library, had it been published earlier!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/12/16/getting-started-with-haskells-warp/">Getting Started With Haskell's Warp</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-12-16T21:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2016/12/16/getting-started-with-haskells-warp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I recently started playing with Haskell&rsquo;s <a href="http://www.aosabook.org/en/posa/warp.html">Warp</a> in my effort to learn Haskell. Warp is small and fast web server, and doesn&rsquo;t come bundled with much. It also has no &ldquo;magic&rdquo; in it, which I think is a very good thing.</p>

<p>My hello-world program for any web server, is to respond with <code>{"hello":"world"}</code>. Here it is:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='haskell'><span class='line'><span class="cm">{-# LANGUAGE OverloadedStrings #-}</span>
</span><span class='line'><span class="cm">{-# LANGUAGE DeriveGeneric, DeriveAnyClass #-}</span>
</span><span class='line'>
</span><span class='line'><span class="kr">module</span> <span class="nn">Main</span> <span class="kr">where</span>
</span><span class='line'>
</span><span class='line'><span class="kr">import</span> <span class="nn">Network.Wai</span> <span class="p">(</span><span class="nf">responseLBS</span><span class="p">,</span> <span class="kt">Application</span><span class="p">,</span> <span class="kt">Response</span><span class="p">,</span> <span class="nf">rawPathInfo</span><span class="p">)</span>
</span><span class='line'><span class="kr">import</span> <span class="nn">Network.Wai.Handler.Warp</span> <span class="p">(</span><span class="nf">run</span><span class="p">)</span>
</span><span class='line'><span class="kr">import</span> <span class="nn">Network.HTTP.Types</span> <span class="p">(</span><span class="nf">status200</span><span class="p">,</span> <span class="nf">status404</span><span class="p">)</span>
</span><span class='line'><span class="kr">import</span> <span class="nn">Network.HTTP.Types.Header</span> <span class="p">(</span><span class="nf">hContentType</span><span class="p">)</span>
</span><span class='line'><span class="kr">import</span> <span class="nn">Data.Aeson</span>
</span><span class='line'><span class="kr">import</span> <span class="nn">GHC.Generics</span>
</span><span class='line'>
</span><span class='line'><span class="kr">data</span> <span class="kt">Hello</span> <span class="ow">=</span> <span class="kt">Hello</span> <span class="p">{</span> <span class="n">hello</span> <span class="ow">::</span> <span class="kt">String</span> <span class="p">}</span> <span class="kr">deriving</span> <span class="p">(</span><span class="kt">Generic</span><span class="p">,</span> <span class="kt">ToJSON</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="nf">main</span> <span class="ow">::</span> <span class="kt">IO</span> <span class="nb">()</span>
</span><span class='line'><span class="nf">main</span> <span class="ow">=</span> <span class="kr">do</span>
</span><span class='line'>  <span class="kr">let</span> <span class="n">port</span> <span class="ow">=</span> <span class="mi">3000</span>
</span><span class='line'>  <span class="n">putStrLn</span> <span class="o">$</span> <span class="s">&quot;Listening on port &quot;</span> <span class="o">++</span> <span class="n">show</span> <span class="n">port</span>
</span><span class='line'>  <span class="n">run</span> <span class="n">port</span> <span class="n">app</span>
</span><span class='line'>
</span><span class='line'><span class="nf">app</span> <span class="ow">::</span> <span class="kt">Application</span>
</span><span class='line'><span class="nf">app</span> <span class="n">req</span> <span class="n">res</span> <span class="ow">=</span>
</span><span class='line'>  <span class="n">res</span> <span class="o">$</span> <span class="kr">case</span> <span class="n">rawPathInfo</span> <span class="n">req</span> <span class="kr">of</span>
</span><span class='line'>    <span class="s">&quot;/&quot;</span> <span class="ow">-&gt;</span> <span class="n">helloRoute</span>
</span><span class='line'>    <span class="kr">_</span>   <span class="ow">-&gt;</span> <span class="n">notFoundRoute</span>
</span><span class='line'>
</span><span class='line'><span class="nf">helloRoute</span> <span class="ow">::</span> <span class="kt">Response</span>
</span><span class='line'><span class="nf">helloRoute</span> <span class="ow">=</span>
</span><span class='line'>  <span class="n">responseLBS</span>
</span><span class='line'>  <span class="n">status200</span>
</span><span class='line'>  <span class="p">[(</span><span class="n">hContentType</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)]</span>
</span><span class='line'>  <span class="o">.</span> <span class="n">encode</span> <span class="o">$</span> <span class="kt">Hello</span> <span class="s">&quot;World&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nf">notFoundRoute</span> <span class="ow">::</span> <span class="kt">Response</span>
</span><span class='line'><span class="nf">notFoundRoute</span> <span class="ow">=</span>
</span><span class='line'>  <span class="n">responseLBS</span>
</span><span class='line'>  <span class="n">status404</span>
</span><span class='line'>  <span class="p">[(</span><span class="n">hContentType</span><span class="p">,</span> <span class="s">&quot;application/json&quot;</span><span class="p">)]</span>
</span><span class='line'>  <span class="s">&quot;404 - Not Found&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, the code has a <code>main</code> function that runs the <code>app</code>. This <code>app</code> just matches on routes, and responds with <code>HTTP 200 OK</code> on the root, or <code>HTTP 404 Not Found</code>. These are returned by different functions which returning <code>Response</code> types, and contain most of the hard parts of this code.</p>

<p>Talking of hard parts, the thing I had the most difficultly with was:</p>

<h3>Working out what <code>responseLBS</code> meant, and how to use it</h3>

<p><code>responseLBS</code> means &ldquo;respond with a LazyByteString&rdquo;. LazyByteString seems to be the standard way of dealing with Strings in Warp. Their laziness, and serialisation format, apparently yields very high performance.</p>

<p>However, using them is not so simple. Unless you convert from a normal String to a LazyByteString, you receive this compiler error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Couldn't match expected type
</span><span class='line'>‘bytestring-0.10.8.1:Data.ByteString.Internal.ByteString’
</span><span class='line'>with actual type ‘[Char]’</span></code></pre></td></tr></table></div></figure>


<p>The <code>OverloadedStrings</code> pragma on the first line makes responseLBS usable, but providing a typeclass that automatically converts Strings to LazyByteStrings. It took me a while to realise this.</p>

<h2>Summary</h2>

<p>One of the best things about this code was the experience writing it. Once it compiled, it worked. It took a while to work out, but it was all helpfully guided by the compiler.</p>

<p>I think I&rsquo;d probably benefit from an IDE for Haskell, as I spend much of my time in IntelliJ coding Scala. Discovering the necessary imports was the trickiest part of coding in the Atom Editor. If you have any recommendations, please send them my way!</p>

<p>IDE&rsquo;s aside, if coding in Haskell is always this pleasant, I&rsquo;ll be very pleased!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/28/learning-akka-streams/">Learning Akka Streams</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-28T11:00:00+01:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2016/06/28/learning-akka-streams/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This blog post differs from my usual ones; I&rsquo;m writing it as I learn something. As such, it is more of a story that contains errors and misunderstanding than a factual blog post.</p>

<h2>Hello World</h2>

<p>This blog post follows me trying to learn how to use <a href="http://doc.akka.io/docs/akka/2.4.7/scala/stream/stream-introduction.html">Akka Streams</a>. I haven&rsquo;t needed to use them before, and whenever I glance at the documentation, I usually get confused about just how many new terms are being introduced.</p>

<p>Runnable code is available <a href="https://github.com/cjwebb/blog-code/tree/master/learning-akka-streams">here</a>. I&rsquo;ve included more type annotations that normal, as they will assist us discussing what is going on.</p>

<p>We start by compiling and running the &lsquo;Hello World&rsquo; example in <a href="http://doc.akka.io/docs/akka/2.4.7/scala/stream/stream-quickstart.html#stream-quickstart-scala">the Quick Start Guide</a>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.NotUsed</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">HelloWorld</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">source</span><span class="o">.</span><span class="n">runForeach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Source</code> will be widely used. It represents the inputs to the stream.</p>

<p>A couple of things stand out in the code. Firstly, the <code>ActorMaterializer</code> is new, compared to standard Akka. I have no idea what it does, but I&rsquo;m guessing it could have been named &ldquo;ActorFactory&rdquo;.</p>

<p>Secondly, the <code>Source</code> takes two type parameters. The first is the type that the <code>Source</code> emits. The documentations says that &ldquo;the second one may signal that running the source produces some auxiliary value (e.g. a network source may provide information about the bound port or the peer’s address)&rdquo;. The first one makes sense. The second one doesn&rsquo;t yet. Things will hopefully become clearer once I write something else.</p>

<p>Either way, this stream runs and prints out 1 to 100.</p>

<h2>Using a Sink</h2>

<blockquote><p>Source &ndash;> Sink</p></blockquote>

<p>The first example uses a <code>Source</code>. It is not really a Stream. We just send everything to <code>stdout</code>. Let&rsquo;s use <code>Sink</code>, which are the outputs of a stream.</p>

<p>There seem to be lots of kinds of <code>Sink</code>, including a <code>foreach</code> one, which we can use to <code>println</code> again.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.Future</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">UsingASink</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">source</span><span class="o">.</span><span class="n">runWith</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Interestingly, the type signature of this is <code>Sink[Any, Future[Done]]</code>. From reading the ScalaDoc, <code>Done</code> is essentially <code>Unit</code>, but they used included it so the code could also run on Java. We&rsquo;ve also used that second mysterious type parameter.</p>

<p>ScalaDoc says &ldquo;The sink is materialized into a [[scala.concurrent.Future]]&rdquo;. Perhaps the ActorMaterializer has been used, and deals with side-effects? Let&rsquo;s keep going, and see if a more complicated example makes it easier to understand.</p>

<h1>Simple Transform</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source --> Flow --> Sink</span></code></pre></td></tr></table></div></figure>


<p>So far, we generate a Stream from an <code>Iterable</code>, send it to a <code>Sink</code>, and then print it out. Let&rsquo;s include an intermediate step, where we do some &ldquo;stream processing&rdquo;. For this, we need the <code>Flow</code> class. This is beginning to look more like the Stream I imagined.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.Future</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">SimpleTransform</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">source</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">helloTimesTen</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot;Hello ${i * 10}&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">graph</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="n">source</span> <span class="n">via</span> <span class="n">helloTimesTen</span> <span class="n">to</span> <span class="n">sink</span>
</span><span class='line'>  <span class="n">graph</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We discovered another type now; <code>RunnableGraph</code>. This is a &ldquo;Flow with attached input and output, can be executed.&rdquo;</p>

<p>That makes sense. We&rsquo;ve attached a <code>Source</code>, and a <code>Sink</code>, to our <code>Flow</code>. Therefore it has input and output, and should work.</p>

<p>RunnableGraph also specifies that it has a <code>ClosedShape</code>, which also hints at the role that a <code>Materializer</code> takes. I&rsquo;m still yet to figure them out.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * This [[Shape]] is used for graphs that have neither open inputs nor open</span>
</span><span class='line'><span class="cm"> * outputs. Only such a [[Graph]] can be materialized by a [[Materializer]].</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">ClosedShape</span> <span class="k">extends</span> <span class="nc">Shape</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Graphs</h2>

<p>All of our examples so far have been very linear. There has been no way of splitting the stream to do different pieces of work, or combine multiple sources.</p>

<p>One use-case I can think of when using Akka Streams is to persist events on the stream to a database, in addition to continuing the stream processing.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source --> Broadcast --> Flow --> Sink
</span><span class='line'>               |
</span><span class='line'>               --> Save to DB</span></code></pre></td></tr></table></div></figure>


<p>Akka Streams has a thing named <code>Broadcast</code> especially for this. However, constructing and using one is more complex than I imaged. You need to start using a mutable <code>GraphDSL.Builder</code>. The GraphDSL implies that we now need to learn what lots of funny symbols mean, such as <code>~&gt;</code>.</p>

<p>We need to build up a <code>Graph[ClosedShape, Mat]</code> where <code>Mat</code> is one of those Materializers that I still don&rsquo;t understand.</p>

<p>Interesting, it seems as though <code>Graph</code> doesn&rsquo;t type-check very well. It is possible to construct and run a Graph that doesn&rsquo;t do anything except fail at runtime. The following code gets checked via a <code>require</code> assertion when running the code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">isRunnable</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="n">inPorts</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="n">outPorts</span><span class="o">.</span><span class="n">isEmpty</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;m not really sure how one would go about asserting this at compile-time. It definitely seems possible though, as other Scala libraries have similar builder patterns that type-check. Hopefully this will be addressed in a future release.</p>

<p>Anyway, lets try and build a Stream that saves events to a DB.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.</span><span class="o">{</span><span class="nc">Done</span><span class="o">,</span> <span class="nc">NotUsed</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">ExecutionContext</span><span class="o">,</span> <span class="nc">Future</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">SendToDB</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">ec</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">dispatcher</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">intSource</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">helloTimesTen</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot;Hello ${i * 10}&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">intToEvent</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">DB.Event</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">DB</span><span class="o">.</span><span class="nc">Event</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Event $i&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">printlnSink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Any</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Done</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span><span class="n">println</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">dbSink</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">DB.Event</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="nc">DB</span><span class="o">.</span><span class="n">persistEvent</span><span class="o">).</span><span class="n">toMat</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">right</span><span class="o">).</span><span class="n">named</span><span class="o">(</span><span class="s">&quot;dbSink&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">graph</span> <span class="k">=</span> <span class="nc">RunnableGraph</span><span class="o">.</span><span class="n">fromGraph</span><span class="o">(</span><span class="nc">GraphDSL</span><span class="o">.</span><span class="n">create</span><span class="o">()</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">GraphDSL.Builder</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">import</span> <span class="nn">GraphDSL.Implicits._</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">broadcast</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">Broadcast</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="mi">2</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">intSource</span> <span class="o">~&gt;</span> <span class="n">broadcast</span> <span class="o">~&gt;</span> <span class="n">helloTimesTen</span> <span class="o">~&gt;</span> <span class="n">printlnSink</span>
</span><span class='line'>                 <span class="n">broadcast</span> <span class="o">~&gt;</span> <span class="n">intToEvent</span> <span class="o">~&gt;</span> <span class="n">dbSink</span>
</span><span class='line'>
</span><span class='line'>    <span class="nc">ClosedShape</span>
</span><span class='line'>  <span class="o">})</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">graph</span><span class="o">.</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">DB</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Event</span><span class="o">(</span><span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">persistEvent</span><span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">Event</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">ec</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// pretend that some DB IO happens here</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;persisting $e&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="nc">Future</span> <span class="o">{}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>There is a lot of new stuff here. Starting with the easiest thing; I&rsquo;ve renamed some vals to reflect what they do now. We also have a new <code>Flow</code> named <code>intToEvent</code> which maps an <code>Int</code> to a <code>DB.Event</code> case class.</p>

<p>We also have the <code>GraphDSL</code> syntax, and implicit conversions. <code>~&gt;</code> means &ldquo;Add Edge to Graph&rdquo; in my head. As DSLs go, it isn&rsquo;t too bad. Arrows are Stream processing go hand-in-hand. I&rsquo;ll try and use this syntax from now on.
The <code>Broadcast</code> class also checks at compile time that we&rsquo;ve linked all the specified &lsquo;ports&rsquo;. In our example, we create the <code>Broadcast</code> and say it will have two things listening to it. If we only connect, one, we get a runtime error.</p>

<p>Lastly, we have a new <code>Sink</code> named <code>dbSink</code>. I basically copied the code from inside the <code>printlnSink</code> and changed the <code>map</code> method. It seems as though in order to perform actions on a Stream, we need to materialize the values contained inside. I now assume that Streams are inherently lazy, and Materializing is the act of evaluating the Stream.</p>

<p>We need to dig into Materializers, and finally figure them out.</p>

<h2>Basic Materializer</h2>

<p>Having read the docs some more, it seems as though &ldquo;materialization&rdquo; is the thing that actually runs our Stream. When using Akka, actors are created (or materialized) in order to do the work. Makes sense. I can&rsquo;t help but feel that this should have been more obvious at the start&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Source ~> Sink</span></code></pre></td></tr></table></div></figure>


<p>We return to the simplest graph, with just a Source and a Sink. The Source generates Ints, and the Sink just takes the first one.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.NotUsed</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.actor.ActorSystem</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">akka.stream.scaladsl._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.duration.Duration</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.</span><span class="o">{</span><span class="nc">Await</span><span class="o">,</span> <span class="nc">Future</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">BasicMaterializer</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">()</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">materializer</span> <span class="k">=</span> <span class="nc">ActorMaterializer</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">intSource</span><span class="k">:</span> <span class="kt">Source</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">NotUsed</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">headSink</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">head</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">graph1</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">intSource</span><span class="o">.</span><span class="n">toMat</span><span class="o">(</span><span class="n">headSink</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">right</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">graph2</span><span class="k">:</span> <span class="kt">RunnableGraph</span><span class="o">[</span><span class="kt">NotUsed</span><span class="o">]</span>     <span class="k">=</span> <span class="n">intSource</span><span class="o">.</span><span class="n">toMat</span><span class="o">(</span><span class="n">headSink</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">left</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// we can only get values from graph1</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">graph1</span><span class="o">.</span><span class="n">run</span><span class="o">(),</span> <span class="nc">Duration</span><span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="s">&quot;seconds&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">println</span><span class="o">(</span><span class="n">result</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>I&rsquo;ve included code of two RunnableGraphs. They only vary in second arguments; <code>Keep.right</code> versus <code>Keep.left</code>. This seems to be the key to Materializers, and the mysterious second type parameter included everywhere in our Source, Flows, and Sinks.</p>

<p>In order to get any values out of a Stream flowing left to right, we need to keep the right values. Presumably, in a stream going the other way, we need to keep the left values. In our case, the right side of our graph has <code>Future[Int]</code> as the second type parameter. This is the one we need.</p>

<p>The types on these methods are very obvious; given two types select the one on the left, or the right.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">left</span> <span class="o">[</span><span class="kt">L</span>, <span class="kt">R</span><span class="o">]</span><span class="k">:</span> <span class="o">(</span><span class="kt">L</span><span class="o">,</span> <span class="kt">R</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">L</span>
</span><span class='line'><span class="k">def</span> <span class="n">right</span><span class="o">[</span><span class="kt">L</span>, <span class="kt">R</span><span class="o">]</span><span class="k">:</span> <span class="o">(</span><span class="kt">L</span><span class="o">,</span> <span class="kt">R</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">R</span>
</span></code></pre></td></tr></table></div></figure>


<p>This now also answers my questions above about the previously used <code>Sink</code> named <code>dbSink</code>. Here&rsquo;s the implementation again:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span><span class="kt">DB.Event</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="nc">DB</span><span class="o">.</span><span class="n">persistEvent</span><span class="o">).</span><span class="n">toMat</span><span class="o">(</span><span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span><span class="o">)(</span><span class="nc">Keep</span><span class="o">.</span><span class="n">right</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>DB.persistEvent</code> returns a <code>Future[Unit]</code>. In order to actually evalutate these Futures, we need to materialize the stream. As we&rsquo;re Keeping right, we pass our futures into <code>Sink.ignore</code>. If we kept left, we pass <code>NotUsed</code>. Whilst ignoring them doesn&rsquo;t sound very useful, this actually runs them before ignoring whatever they return.</p>

<p>I feel like I understand roughly how Akka Streams work now.</p>

<p>Here&rsquo;s a recap.</p>

<ul>
<li>Sources generate values.</li>
<li>Sinks consume values.</li>
<li>Materialization is the process of running the Stream, and getting your Sink to do something.</li>
<li>Flows are linear transformations.</li>
<li>Graphs can be modelled with Broadcast (and Merge, but we didn&rsquo;t try them out).</li>
</ul>


<p>This is enough blog post for now. I&rsquo;d like to continue learning Akka Streams; they seem a lot easier to use than Actors, and patterns are built in. Streams are more type-safe than Actors too, which hopefully will permit writing more maintainable code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/06/15/the-virtues-of-side-projects/">The Virtues of Side Projects</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-06-15T11:00:00+01:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2016/06/15/the-virtues-of-side-projects/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I write software for a living, and most of my side projects are software based too. I view side projects as a tool for learning. Learning by doing.</p>

<h2>Side projects can feed positively into your day job, as you learn new skills and techniques</h2>

<p>Building things from scratch, and by yourself, means you have to broaden your knowledge base. If you&rsquo;re writing a website, you&rsquo;ll need to know how to deploy it, how to enable database backups, how to configure a firewall, and basic server maintenance tools.</p>

<p>When I first started a side project, I wrote Java all day, and developed on Windows. I knew hardly anything about Linux, and certainly had no experience running a server. Whilst it wasn&rsquo;t necessarily all fun, I learnt a lot that has been widely applicable later on in my career.</p>

<p>Side projects can also assist in your day job directly. An example of this very happened recently to me. A couple of colleagues were pair programming on an adjacent desk. They were stuck on something, and casually asked if I knew how to fix a problem they were having. After a minute or so looking at the code, my answer was “Yeah, I did something like this recently in my side project”. I then sent them a link to my side project on Github, and after adapting my code, they had solved their issue and were away coding again.</p>

<p>Usually it&rsquo;s skills and techniques that will transfer over from side-projects. Occasionally, you can just copy some of your side project code.</p>

<h2>Side projects let you experiment without adversely affecting your day-job</h2>

<p>Want to learn Haskell? Great! But don&rsquo;t then deploy it at work, and <strong>force</strong> other people to maintain your code.</p>

<p>Want to try out a theory about structuring an object-orientated codebase? You can, and if it doesn&rsquo;t work out, you won&rsquo;t have annoyed all of your colleagues.</p>

<p>Having a great job, or working on a great team, means that you&rsquo;re given time to learn or embrace different technologies or techniques. However, if you&rsquo;re not that lucky, side projects can give you the freedom to learn and experiment in ways you wouldn&rsquo;t normally be allowed to.</p>

<h2>Side projects can die without negative consequences</h2>

<p>If you get bored with working on a side project, just stop working on it. A project with paying customers is not a side project. Nobody can honestly expect you to keep working for free on something you find boring.</p>

<p>Work on something different for a while. If the side project doesn&rsquo;t interest you again, forget about it, and thank it for the experience and skills you gained whilst working on it.</p>

<h2>Side projects can force you to think differently</h2>

<p>Compared to your day job, side projects are subject to a different set of constraints. Different constraints means different problems to solve. Your decisions will be different as a result of this.</p>

<p>The main constraint on my side projects is money. At most places I&rsquo;ve worked, the budget is usually huge in comparison to what I can set aside. EC2 instances costs nothing to a corporation, but ~$50/month, multiplied by three for redundancy and replication, soon make a dent in my own finances.</p>

<p>This constraint has also led me to use a lot of free-tiers of hosted-database providers. If a company is willing to provide me with free services, then I&rsquo;m all ears. This was how I was introduced to NoSQL databases, and I gained a completely different perspective on how to store, and query, data.</p>

<h2>Side projects count as experience</h2>

<p>Always be learning. There is a famous quote by Malcolm Gladwell about how doing something for ten thousand hours can help achieve mastery. Whilst this quote is often <a href="https://www.reddit.com/r/IAmA/comments/2740ct/hi_im_malcolm_gladwell_author_of_the_tipping/chx6ku3">out of context</a>, everyone understands that you need to practice something in order to become better at it. The good news, is that you can practice your skills whilst working on a fun side-project.</p>

<p>The second piece of good news, is that you can often use side projects as direct evidence to show off to potential employers. I&rsquo;ve often chatted about my side projects whilst being interviewed, and I&rsquo;ve often chatted about interviewees' side projects whilst I interviewed them. They&rsquo;re a great way to showcase your talents!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/01/elm-in-octopress/">Using Elm in Octopress</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-01T07:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2016/01/01/elm-in-octopress/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://elm-lang.org/">Elm</a> is a functional programming language aimed at the browser. It aims to replace all HTML, CSS, and JavaScript code. It borrows a lot from Haskell, and promises that if your Elm code compiles, it will run without exceptions.</p>

<p>Animated, or interactive, examples can greatly enhance blog posts. This is ultimately achieved via embedding HTML, CSS, and JavaScript. My blog is powered by <a href="http://octopress.org/">Octopress</a>, and instead of writing HTML, CSS, and JavaScript, I was interested in using Elm instead.</p>

<h2>Including JavaScript in an Octopress Post</h2>

<p>Running arbitary JavaScript in Octopress is easy. The code below will insert an HTML paragraph into a <code>div</code>.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;elm-goes-here&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;elm-goes-here&quot;</span><span class="p">);</span>
</span><span class='line'>  <span class="nx">element</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;This is set via JavaScript!!&lt;/p&gt;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Instead of inlining the JavaScript, you can include it in the <code>source/javascripts/</code> directory. After publishing, that directory is made available as <code>/javascripts/</code></p>

<h2>Including Elm in an Octopress Post</h2>

<p>As we can use arbitary JavaScript in an Octopress blog post, we can follow a few simple steps, and have the browser running our Elm code instead!</p>

<p><a href="http://elm-lang.org/guide/interop">Elm has interop with JavaScript</a> through HTML embedding (and a couple of other ways). In order to embed in a <code>div</code>, we first need to write and then compile our Elm code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>elm-make Stamps.elm –output=app.js</span></code></pre></td></tr></table></div></figure>


<p>Once compiled, and made available by placing it in the <code>source/javascripts/</code> directory, we can then include it in the blog post.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;elm-goes-here&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;/javascripts/app.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;elm-goes-here&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">Elm</span><span class="p">.</span><span class="nx">embed</span><span class="p">(</span><span class="nx">Elm</span><span class="p">.</span><span class="nx">Stamps</span><span class="p">,</span> <span class="nx">elmDiv</span><span class="p">);</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a demonstration, have a quick play with the interactive section below. It is an embedded version of <a href="http://elm-lang.org/examples/stamps">Elm&rsquo;s Stamps Example</a>.
<code>Elm.embed</code> requires a module to import, so if you&rsquo;d like to try this yourself, add the following to the top of your Elm code.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>module Stamps where</span></code></pre></td></tr></table></div></figure>




<div id="elm-goes-here" style="height:200px; border:1px solid; margin-bottom: 30px;"></div>


<script type="text/javascript" src="/javascripts/posts/elm-in-octopress/app.js"></script>


<script>
  var element = document.getElementById("elm-goes-here")
  Elm.embed(Elm.Stamps, element);
</script>


<p>If you don&rsquo;t like pentagons, <a href="http://elm-lang.org/examples/">there are lots of other Elm examples</a> to play around with.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/23/play-framework-path-binders/">Using Play-Framework's PathBindable</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-23T19:45:00+01:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/06/23/play-framework-path-binders/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Using custom types in <a href="https://www.playframework.com/documentation/2.4.x/ScalaRouting">Play Framework’s routes file</a> is a major win, and is not something obviously supported. Consider the routes file below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">GET</span> <span class="o">/</span><span class="n">stuff</span><span class="o">/:</span><span class="n">id</span>     <span class="nd">@controllers</span><span class="o">.</span><span class="nc">StuffController</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="nc">GET</span> <span class="o">/</span><span class="n">things</span><span class="o">/:</span><span class="n">id</span>    <span class="nd">@controllers</span><span class="o">.</span><span class="nc">ThingsController</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">java.util.UUID</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In the first route, we take the id parameter as a String. In the second, we take it as a <code>java.util.UUID</code>.</p>

<h2>Advantages</h2>

<p>In our example above, paths that do not contains UUIDs are not matched for the second route. We don’t have to deal with IDs that are not UUIDs.</p>

<p>At the start of a project, you may see lots of lines that say:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">id</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">case</span> <span class="n">i</span> <span class="k">if</span> <span class="n">isUUID</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">doStuff</span><span class="o">()</span>
</span><span class='line'>   <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">BadRequest</span><span class="o">(</span><span class="err">“</span><span class="n">id</span> <span class="n">must</span> <span class="n">be</span> <span class="n">a</span> <span class="nc">UUID</span><span class="err">”</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>By not matching on the route, we can remove this code. A request either matches a route, and is passed to the controller, or it doesn’t, and the controller never knows about the request.</p>

<p>By allowing types, and not just strings, you can avoid <a href="http://c2.com/cgi/wiki?StringlyTyped">stringly-typed</a> controllers. Admittedly, UUIDly-typed is only a small step in the right direction, but still a significant improvement.</p>

<h2>Disadvantages</h2>

<p>You need to fully-qualify the types in the routes file, for example by using <code>java.util.UUID</code> everywhere. You cannot use imports in the routes file. Hopefully someone will find a solution to that at some point.</p>

<h2>Implementation</h2>

<p>There are two things that need doing before you can use custom types in the routes file. Firstly, you must implement a <code>PathBindable</code> and its <code>bind</code> and <code>unbind</code> methods. For a UUID, this is quite simple. The <code>bind</code> method returns an <code>Either</code> so that you can return the a message for why the route did not match.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">util</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">java.util.UUID</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.mvc.PathBindable</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Binders</span> <span class="o">{</span>
</span><span class='line'>   <span class="k">implicit</span> <span class="k">def</span> <span class="n">uuidPathBinder</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">PathBindable</span><span class="o">[</span><span class="kt">UUID</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">bind</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Either</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">UUID</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>         <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="nc">Right</span><span class="o">(</span><span class="nc">UUID</span><span class="o">.</span><span class="n">fromString</span><span class="o">(</span><span class="n">value</span><span class="o">))</span>
</span><span class='line'>         <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">IllegalArgumentException</span> <span class="o">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="s">&quot;Id must be a UUID&quot;</span><span class="o">)</span>
</span><span class='line'>         <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">unbind</span><span class="o">(</span><span class="n">key</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">value</span><span class="k">:</span> <span class="kt">UUID</span><span class="o">)</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">toString</span>
</span><span class='line'>   <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Secondly, you must make Play aware of this class, by changing your build file.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.PlayImport.PlayKeys._</span>
</span><span class='line'>
</span><span class='line'><span class="n">routesImport</span> <span class="o">+=</span> <span class="s">&quot;utils.Binders._&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After those two steps, you can then use types in the routes file.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/02/cassandra-ttl-is-per-column/">Cassandra TTL Is Per Column</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-02T11:30:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/03/02/cassandra-ttl-is-per-column/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://cassandra.apache.org/">Cassandra</a> Time-To-Live (TTL) is decribed in the <a href="http://www.datastax.com/documentation/cql/3.0/cql/cql_using/use_ttl_t.html">Datastax documentation</a>. This blog post briefly explores it to demonstrate that TTL is set per column, and not per row.</p>

<p>We start by recreating the example given in the documentation. We create a keyspace, a table, and insert some data into it. The TTL value is much lower than the offical documentation, as I don&rsquo;t want to wait 24 hours before the TTL runs out.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cqlsh> CREATE KEYSPACE excelsior WITH REPLICATION =
</span><span class='line'>         { 'class' : 'SimpleStrategy', 'replication_factor': 1 }
</span><span class='line'>
</span><span class='line'>cqlsh> CREATE TABLE excelsior.clicks (
</span><span class='line'>         userid uuid,
</span><span class='line'>         url text,
</span><span class='line'>         date timestamp,
</span><span class='line'>         name text,
</span><span class='line'>         PRIMARY KEY (userid, url)
</span><span class='line'>       );
</span><span class='line'>
</span><span class='line'>cqlsh> INSERT INTO excelsior.clicks (
</span><span class='line'>         userid, url, date, name)
</span><span class='line'>       VALUES (
</span><span class='line'>         3715e600-2eb0-11e2-81c1-0800200c9a66,
</span><span class='line'>         'http://apache.org',
</span><span class='line'>         '2013-10-09', 'Mary')
</span><span class='line'>       USING TTL 60;</span></code></pre></td></tr></table></div></figure>


<p>Now that we have created our keyspace and table, let&rsquo;s query the TTL:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cqlsh> SELECT TTL (date), TTL (name) from excelsior.clicks;
</span><span class='line'>
</span><span class='line'> ttl(date) | ttl(name)
</span><span class='line'>-----------------------
</span><span class='line'>        52 |        52</span></code></pre></td></tr></table></div></figure>


<h2>Insert or Update to change TTL per column</h2>

<p>As demonstrated by the CQL synatx, TTL is set per column. To demonstrate this, we now insert the data again, but exclude the date.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cqlsh> INSERT INTO excelsior.clicks (
</span><span class='line'>         userid, url, name)
</span><span class='line'>         VALUES (
</span><span class='line'>           3715e600-2eb0-11e2-81c1-0800200c9a66,
</span><span class='line'>           'http://apache.org',
</span><span class='line'>           'Mary')
</span><span class='line'>         USING TTL 60;
</span><span class='line'>cqlsh> SELECT TTL (date), TTL (name) from excelsior.clicks;
</span><span class='line'>
</span><span class='line'> ttl(date) | ttl(name)
</span><span class='line'>-----------+-----------
</span><span class='line'>        11 |        49</span></code></pre></td></tr></table></div></figure>


<p>If we then wait 11 seconds, we can see that different columns can expire at different times.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>cqlsh> select * from excelsior.clicks;
</span><span class='line'>
</span><span class='line'> userid                               | url               | date | name
</span><span class='line'>--------------------------------------+-------------------+------+------
</span><span class='line'> 3715e600-2eb0-11e2-81c1-0800200c9a66 | http://apache.org | null | Mary</span></code></pre></td></tr></table></div></figure>


<p>This can come as a surprise if you&rsquo;re used to rows behaving as one single entity. If you want to update the TTL for an entire row in Cassandra, you need to either insert or update the entire row again with a new TTL.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/02/02/scalatest-futures/">ScalaTest and Twitter Futures</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-02-02T19:45:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/02/02/scalatest-futures/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Scala has nice abstractions for asynchronous code. However, writing tests for that code sometimes results in an ugly, unreadable mess. Fortunately, ScalaTest has built-in support for testing Futures, in addition to utilities for other types of asynchronous testing, such as polling and test-probes.</p>

<h2>org.scalatest.concurrent.Futures</h2>

<p>ScalaTest has <a href="http://doc.scalatest.org/2.0/#org.scalatest.concurrent.Futures">a trait named Futures</a> which defines functions such as <code>whenReady</code>, and other goodies like a <code>futureValue</code> method to help your async tests become terser. However, ScalaTest only comes with support for the standard-library Futures. To use them, mixin <code>org.scalatest.concurrent.ScalaFutures</code>.</p>

<p>If, currently like me, you&rsquo;re using <a href="https://twitter.github.io/finagle/guide/Futures.html#futures">Twitter Futures</a>, then you need to define your own support for them. Luckily, it is quite easy to define support for any Futures library.</p>

<p>Behold a TwitterFutures trait:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">com.twitter.util.</span><span class="o">{</span><span class="nc">Throw</span><span class="o">,</span> <span class="nc">Return</span><span class="o">}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">org.scalatest.concurrent.Futures</span>
</span><span class='line'>
</span><span class='line'><span class="k">trait</span> <span class="nc">TwitterFutures</span> <span class="k">extends</span> <span class="nc">Futures</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">import</span> <span class="nn">scala.language.implicitConversions</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">def</span> <span class="n">convertTwitterFuture</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">twitterFuture</span><span class="k">:</span> <span class="kt">com.twitter.util.Future</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">FutureConcept</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">FutureConcept</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">eitherValue</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Either</span><span class="o">[</span><span class="kt">Throwable</span>, <span class="kt">T</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">twitterFuture</span><span class="o">.</span><span class="n">poll</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="nc">Return</span><span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Right</span><span class="o">(</span><span class="n">o</span><span class="o">)</span>
</span><span class='line'>          <span class="k">case</span> <span class="nc">Throw</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="nc">Left</span><span class="o">(</span><span class="n">e</span><span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">isCanceled</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>      <span class="k">override</span> <span class="k">def</span> <span class="n">isExpired</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">false</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You may also have to define an implicit <code>PatienceConfig</code> for your tests as the default settings will timeout after 150 milliseconds.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">asyncConfig</span> <span class="k">=</span> <span class="nc">PatienceConfig</span><span class="o">(</span><span class="n">timeout</span> <span class="k">=</span> <span class="n">scaled</span><span class="o">(</span><span class="nc">Span</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Polling?</h2>

<p>Strangely, ScalaTest chooses to poll futures, despite both Scala and Twitter Futures coming with <code>Await</code> functions that handle timeouts. Using that as a starting point would have seemed more sensible to me. However, I&rsquo;m not the author of a successful Scala testing library, and I&rsquo;m sure that author <a href="http://twitter.com/bvenners">Bill Venners</a> had a reason. However, it is worth noting.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/20/canned-responses/">Mock Responses and Iterate</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-01-20T19:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2015/01/20/canned-responses/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>&lsquo;Agile&rsquo; may now be an overloaded term abused by all kinds of people, but <a href="http://agilemanifesto.org/">the original manifesto</a> is actually still quite relevant. The second point is:</p>

<blockquote><p>Working software over comprehensive documentation</p></blockquote>

<p>This is useful to embrace in many circumstances, and can be expanded to:</p>

<blockquote><p>You should intially favour building software over documenting it. Comprehensive documentation can come later.</p></blockquote>

<p>I have used the following formula for the last few internal APIs I have worked on, and it makes for fun, fast, and collaborative development:</p>

<ol>
<li>Write API layer that returns mock responses</li>
<li>Deploy it</li>
<li>Solicit feedback from those consuming the API</li>
<li>Make changes to API layer to address feedback</li>
<li>Repeat</li>
</ol>


<p>A mock-response is one that does not change, even when API parameters do. It is hardcoded. If you request <code>GET /users/123</code> you get the same data as when requesting <code>GET /users/456</code>.</p>

<p>The point is to get something deployed as quickly as possible, and get feedback on it. When the API is more stable, the mock-responses can become dynamic and then persisted. Soliciting feedback is the highest priority until then. Nobody can write the perfect API the first time, and receiving and responding to feedback as early as possible saves development time later.</p>

<h2>Tools</h2>

<p>There are several tools available to help you develop an API and iterate upon it. <a href="http://wiremock.org/">WireMock</a> can be configured with a routes file, and mock-responses, and can easily run <a href="http://wiremock.org/running-standalone.html">in standalone mode</a>. Just edit a couple of files, and deploy!</p>

<p>If deployment is a problem, check out <a href="https://getsandbox.com/">getsandbox.com</a>. They provide a JavaScript sandbox to easily return some mock-responses.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/12/31/code2014/">#Code2014</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-31T07:00:00+00:00" pubdate data-updated="true"></time>
        
         | <a href="/blog/2014/12/31/code2014/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As the end of the year approaches, Twitter has a hash-tag named <a href="https://twitter.com/search?src=typd&amp;q=%23code2014">#Code2014</a> that encourages people to tweet which programming languages they&rsquo;ve been using over the last 12 months.</p>

<blockquote class="twitter-tweet" lang="en"><p><a href="https://twitter.com/hashtag/code2014?src=hash">#code2014</a> : Scala, Clojure, Haskell, Java, JavaScript, Python, Golang, Lua, Racket (and also read some Elixir &amp; Erlang books)</p>&mdash; Colin Webb (@colinjwebb) <a href="https://twitter.com/colinjwebb/status/549941162715660288">December 30, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>I joined in, but afterwards felt compelled to explain my thoughts on each in more than 140 characters. Hence this blog post.</p>

<h3>Scala</h3>

<p>My main language, and the one I am gainly employed to write in. I found myself at the Scala Exchange conference again this year, and was pleasantly surprised by the attention that <a href="https://github.com/scalaz/scalaz">Scalaz</a> was receiving. A lot of people were still unconvinced, but the Scalaz talks were very well attended.</p>

<p>I have also found myself immersed in <a href="http://monkey.org/~marius/funsrv.pdf">Twitter&rsquo;s Scala-Ecosystem</a> in the last quarter of the year. I&rsquo;m thoroughly enjoying it. I have become more convinced that Akka is middleware, and Futures (rather than Actors) are more than sufficient for the vast majority of use-cases.</p>

<h3>Java</h3>

<p>First-class functions are so incredibly versatile, that I now get frustrated when using Java.</p>

<p>On a related note, this tweet amused me this year:</p>

<blockquote class="twitter-tweet" lang="en"><p>OH: &quot;But functional programming is too complicated.&quot; <a href="http://t.co/ksPeGgvMgE">pic.twitter.com/ksPeGgvMgE</a></p>&mdash; Bryan Maass (@escherize) <a href="https://twitter.com/escherize/status/546812640387809280">December 21, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>For a greenfield project, I&rsquo;m not sure why I would ever choose Java over Scala again.</p>

<h3>Haskell</h3>

<p>It has been said that Scalaz is a gateway drug from Scala to Haskell, but it is the blurred lines between OOP and FP in Scala that occasionally irritate me. As a pure language, Haskell will hopefully not have the same kind of problems. I have now finally finished reading <a href="http://learnyouahaskell.com/">LYAHFGG</a> and I will start writing more things in Haskell next year.</p>

<h3>Clojure</h3>

<p>I was incredibly excited by Clojure at the beginning of the year, but my excitement is beginning to wane. I would love to love Clojure; the collections libraries are magnificent, it is incredibly concise, and the premise of <a href="http://en.wikipedia.org/wiki/S-expression">s-expressions</a> is compelling. However, the lack of static typing constantly annoys me. <a href="https://github.com/clojure/core.typed">Typed Clojure</a> and/or <a href="https://github.com/Prismatic/schema">Prismatic Schema</a> may alleviate my concerns though. I need to spend more time investigating them.</p>

<h3>Racket</h3>

<p>I have been working my way through <a href="http://www.amazon.co.uk/The-Little-Schemer-Daniel-Friedman/dp/0262560992">The Little Schemer</a>, and apparently they had renamed Scheme to Racket.
I&rsquo;m not convinced it is as nice as Clojure, but might be worth investigating <a href="http://docs.racket-lang.org/ts-guide/">Typed Racket</a> if the libraries to provide typing in Clojure don&rsquo;t turn out very well.</p>

<h3>JavaScript</h3>

<p>JavaScript is still the only realistic choice when writing for the browser, which means that it will be necessary for years to come. I spent a lot more time using it this year, having written both client-side and server-side JavaScript over the past twelve months.</p>

<p>I also re-read <a href="http://www.amazon.co.uk/JavaScript-Good-Parts-Douglas-Crockford/dp/0596517742">JavaScript: The Good Parts</a>, shortly followed by the excellent <a href="http://www.amazon.co.uk/Functional-JavaScript-Introducing-Programming-Underscore-js/dp/1449360726">Functional JavaScript</a>. The latter shows that JavaScript could actually be a very nice language, if everyone followed the same path.</p>

<p>The &ldquo;Good Parts&rdquo; are constantly shrinking though, as Douglas Crockford revised his advice:</p>

<blockquote class="twitter-tweet" lang="en"><p>Doug Crockford has stopped using &quot;this&quot;, null and falsiness in JS - fantastic advice. <a href="https://twitter.com/hashtag/fullstackcon?src=hash">#fullstackcon</a> <a href="http://t.co/nGfAsj5cpm">pic.twitter.com/nGfAsj5cpm</a></p>&mdash; James Pamplin (@pampo) <a href="https://twitter.com/pampo/status/525208703197523968">October 23, 2014</a></blockquote>


<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>


<p>It might be nice to see a new CoffeScript-esque JavaScript compiler that errors if you don&rsquo;t use the Good Parts. Either that, or I need to spend time having a proper look at <a href="https://github.com/clojure/clojurescript">ClojureScript</a> and <a href="http://www.purescript.org/">PureScript</a>.</p>

<h3>Python</h3>

<p>Python is my default scripting language. I enjoyed <a href="https://www.paypal-engineering.com/2014/12/10/10-myths-of-enterprise-python/">PayPal debunking some myths of Enterprise Python</a>, but Python is slow and lacks good concurrency support in comparison to Scala.</p>

<h3>Golang</h3>

<p>I have written a couple of utilities and one website in Golang this year. It could potentially replace Python as my default &ldquo;operations&rdquo; language once I learn more of the standard library.</p>

<p>It is annoying that it doesn&rsquo;t have a <code>map</code> function though, and without immutable data structures, I probably won&rsquo;t ever trust it to build anything complicated.</p>

<h3>Lua</h3>

<p>Lua is a language I will spend more quality time with in 2015. Having previously worked with Lua when embedding it in Redis, I was excited to discover <a href="http://openresty.org/">OpenResty</a> and being able to embed it into NGINX. I also want to investigate using <a href="http://willcrichton.github.io/terracuda/">Lua for CUDA GPU Programming</a>.</p>

<h2>More In 2015?</h2>

<p>Aside from those already listed, I need to spend some time with Erlang next year. I have now read a couple of books about it (including the excellent <a href="http://learnyousomeerlang.com/">Learn You Some Erlang</a>), and I really need to write some to experience it firsthand.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017/01/02/dynamodb-scala-macros/">DynamoDB With Scala Macros</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/12/16/getting-started-with-haskells-warp/">Getting Started With Haskell's Warp</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/28/learning-akka-streams/">Learning Akka Streams</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/06/15/the-virtues-of-side-projects/">The Virtues of Side Projects</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/01/elm-in-octopress/">Using Elm in Octopress</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>About Me</h1>
  <p>My name is Colin Webb, and I'm a software consultant.</p>
  <p>I write software, teach people, and investigate new technology.</p>

  <p>You can find me on Twitter <a href="http://twitter.com/colinjwebb">@colinjwebb</a>, or generally online at <a href="http://colinjameswebb.com">colinjameswebb.com</a></p>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Colin Webb -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'cjwebbgithubio';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
